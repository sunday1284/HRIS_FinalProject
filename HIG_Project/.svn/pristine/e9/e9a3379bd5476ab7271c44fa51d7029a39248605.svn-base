let stompClient;
const senderId = sessionStorage.getItem("currentUserId"); // í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ID

function connectChatRoom() {
  const socket = new SockJS("/wss");
  stompClient = Stomp.over(socket);

  stompClient.connect({}, function (frame) {
    console.log("ğŸŸ¢ ì±„íŒ…ë°© ì—°ê²°ë¨:", frame);

    stompClient.subscribe(`/topic/chat/${roomId}`, function (message) {
      const chat = JSON.parse(message.body);
      console.log("ë°›ì€ ë©”ì‹œì§€:", chat);
      showMessage(chat, true); // ì‹¤ì‹œê°„ ë©”ì‹œì§€ = ì•Œë¦¼ ê°€ëŠ¥
    });
  });
}

function sendMessage() {
  const content = $("#chatInput").val();
  if (!content || !senderId) return;

  const msg = {
    roomId: roomId,
    senderId: senderId,
    messageText: content
  };

  stompClient.send("/app/chat.send", {}, JSON.stringify(msg));
  $("#chatInput").val("");
}

function showMessage(chat, notify = false) {
  const isMine = chat.senderId === senderId;
  const openRoomId = sessionStorage.getItem("openRoomId");

  console.log(" notify:", notify, "isMine:", isMine);
  console.log(" chat.roomId:", chat.roomId, "openRoomId:", openRoomId);

  //ì•Œë¦¼ ì¡°ê±´: ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì•„ë‹ˆê³ , ê¶Œí•œ ìˆê³ , ë‹¤ë¥¸ ë°©ì¼ ë•Œë§Œ
  if (notify && !isMine && Notification.permission === "granted") {
    if (String(chat.roomId) !== openRoomId) {
      console.log("ë¸Œë¼ìš°ì € ì•Œë¦¼ ì‹¤í–‰!");
      new Notification(`${chat.senderName}ë‹˜`, {
        body: chat.messageText,
        icon: "https://cdn-icons-png.flaticon.com/512/3588/3588530.png"
      });
    } else {
      console.log("í˜„ì¬ ì—´ë ¤ìˆëŠ” ì±„íŒ…ë°©ì´ë¼ ì•Œë¦¼ X");
    }
  }

  let sentTime = "";
  if (chat.sentAt) {
    const date = new Date(chat.sentAt);
    if (!isNaN(date)) {
      sentTime = date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }
  }

  const messageHtml = `
    <div class="chat-message ${isMine ? 'mine' : 'other'}">
      <div class="chat-bubble">
        <div><strong>${chat.senderName}</strong>: ${chat.messageText}</div>
        <div class="chat-time">${sentTime}</div>
      </div>
    </div>
  `;

  $("#chat-box").append(messageHtml);
  $("#chat-box").scrollTop($("#chat-box")[0].scrollHeight);

  if (!isMine) {
    readMessage(chat.messageId, senderId);
  }
}

function loadPreviousMessages() {
  console.log("ì´ì „ ë©”ì‹œì§€ ë¡œë”©...");
  $.ajax({
    url: "/messenger/messages",
    type: "GET",
    data: { roomId: Number(roomId) },
    success: function (messages) {
      messages.forEach(msg => showMessage(msg, false)); // ì•Œë¦¼ ì—†ì´ ì¶œë ¥
    },
    error: function () {
      alert("ì´ì „ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  });
}

function readMessage(messageId, empId) {
  $.ajax({
    url: "/messenger/message/read",
    type: "POST",
    data: { messageId, empId },
    success: function () {
      console.log("ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬:", messageId);
    },
    error: function () {
      console.error("ë©”ì‹œì§€ ì½ìŒ ì‹¤íŒ¨:", messageId);
    }
  });
}

function requestNotificationPermission() {
  if (!("Notification" in window)) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
    return;
  }

  if (Notification.permission === "default") {
    Notification.requestPermission().then(permission => {
      if (permission === "granted") {
        console.log("ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨");
      } else {
        console.warn("ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨");
      }
    });
  } else {
    console.log("ğŸ“Œ í˜„ì¬ ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ:", Notification.permission);
  }
}

$(document).ready(function () {
  console.log("ChatRoom.js ë¡œë”©ë¨");

  requestNotificationPermission(); // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
  sessionStorage.setItem("openRoomId", String(roomId)); // í˜„ì¬ ë°© ì—´ë¦¼ ìƒíƒœ ì €ì¥

  connectChatRoom();
  loadPreviousMessages();

  $("#sendBtn").on("click", sendMessage);

  $("#chatInput").on("keypress", function (e) {
    if (e.which === 13) sendMessage();
  });

  $("#closeBtn").on("click", function () {
    sessionStorage.removeItem("openRoomId"); // ë°© ë‹«ìœ¼ë©´ ìƒíƒœ ì œê±°
    window.close();
  });

  // í˜¹ì‹œ ë¸Œë¼ìš°ì € ì°½ ë‹«ì„ ë•Œë„ ì œê±°ë˜ê²Œ
  window.addEventListener("beforeunload", function () {
    sessionStorage.removeItem("openRoomId");
  });
});
