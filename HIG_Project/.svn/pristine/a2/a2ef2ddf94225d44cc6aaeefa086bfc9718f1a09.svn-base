$(document).ready(function() {

	fetch('/employee/getEmployeeCountByDepartment')
	    .then(response => response.json())
	    .then(data => {
			console.log(data);

	        window.deptEmpList = data;  // ì´ê²Œ ê°€ì ¸ì™€ì„œ ì¶œë ¥í•´ì£¼ëŠ” ë¶€ë¶„??
	        console.log("deptEmpList ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", window.deptEmpList);
	        deptEmpCountChart(); // ì°¨íŠ¸ í•¨ìˆ˜ ì‹¤í–‰
	    })
	    .catch(error => console.error("ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error));

	   // ë¶€ì„œë³„ ì§ì› ìˆ˜ ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
	   function deptEmpCountChart() {
	       if (window.deptEmpList && Array.isArray(window.deptEmpList)) {
	           const deptLabels = [];
	           const deptData = [];
	           /*const deptColors = [];*/
			   const deptColors = [
			       "#5c61b4", // ê²½ì˜ì§€ì›ë³¸ë¶€
			       "#2cc4bc", // ë§ˆì¼€íŒ…ë³¸ë¶€
			       "#ffc532", // ì—°êµ¬ê°œë°œë³¸ë¶€
			       "#f1716e", // ìƒì‚°ë³¸ë¶€
			       "#acacdc", // í…ŒìŠ¤íŠ¸ ë¶€ì„œ


			       "#E74C3C", // ë¶€ì„œ 6
			       "#1ABC9C", // ë¶€ì„œ 7
			       "#2C3E50"  // ë¶€ì„œ 8
			   ];


	           window.deptEmpList.forEach(function(dept) {
	               deptLabels.push(dept.departmentName);
	               deptData.push(dept.departmentEmployeeCount);
	               /*deptColors.push('#' + Math.floor(Math.random() * 16777215).toString(16));*/
	           });

	           const totalEmployees = deptData.reduce((sum, count) => sum + count, 0);
	           const ctx = document.getElementById('deptEmpCountChart').getContext('2d');

			   new Chart(ctx, {
			     type: 'pie',
			     data: {
			       labels: deptLabels,
			       datasets: [{
			         label: 'ë¶€ì„œë³„ ì§ì› ìˆ˜',
			         data: deptData,
			         backgroundColor: deptColors,
			         hoverOffset: 4
			       }]
			     },
			     plugins: [ChartDataLabels],
			     options: {
			       responsive: true,
			       plugins: {
			         legend: { position: 'top' },
			         title: {
			           display: true,
			           text: 'ë¶€ì„œë³„ ì§ì› ìˆ˜',
			           font: { size: 16 }
			         },
			         datalabels: {
						formatter: function(value, context) {
						  const label = context.chart.data.labels[context.dataIndex]; // ë¶€ì„œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
						  const total = deptData.reduce((a, b) => a + b, 0);
						  const percent = ((value / total) * 100).toFixed(1);
						  return `${label}\n${value}ëª…(${percent}%)`; // ğŸ‘ˆ ë¶€ì„œëª… ì¶”ê°€
						},
			           font: { size: 16 },
			           color: '#000',
			           anchor: 'center',
			           align: 'end',
			           offset: 5,
			           clamp: true,
			           clip: false
			         },
			         tooltip: {
			           callbacks: {
			             label: function(context) {
			               const label = context.label || '';
			               const value = context.raw || 0;
			               const percent = ((value / deptData.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
			               return `${label}: ${value}ëª… (${percent}%)`;
			             }
			           }
			         }
			       }
			     }
			   });


	       } else {
	           console.error('deptEmpList ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.');

	       }

	   }



    // AJAX ìš”ì²­ìœ¼ë¡œ ë¶€ì„œ ë°ì´í„°ë¥¼ ì¡°íšŒ
    $.ajax({
        url: window.contextPath + '/employee/getDepartments',
        method: 'GET',
        dataType: 'json',
        success: function(response) {
            console.log("ë°›ì€ ì‘ë‹µ:", response);
            var departmentList = Array.isArray(response) ? response : (response.data ? response.data : []);
            var orgData = processOrgData(departmentList);
            console.log("ê°€ê³µëœ ì¡°ì§ ë°ì´í„°:", orgData);

            // FancyTree ì´ˆê¸°í™”: glyph ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ê¸°ë³¸ ì•„ì´ì½˜ ì„¤ì •
            $("#orgTree").fancytree({
                glyph: {
                    map: {
                        expanderClosed: "fas fa-plus-square",   // ì ‘í˜ ì•„ì´ì½˜
                        expanderOpen: "fas fa-minus-square",      // í¼ì¹¨ ì•„ì´ì½˜
                        folder: "fas fa-folder",                  // í´ë” ì•„ì´ì½˜ (ì¼ë°˜ ë…¸ë“œ)
                        folderOpen: "fas fa-folder-open"          // í¼ì³ì§„ í´ë” ì•„ì´ì½˜
                    }
                },
                source: orgData,
                activate: function(event, data) {
                    console.log("í´ë¦­í•œ ë…¸ë“œ:", data.node);
                    console.log("ë…¸ë“œ ë°ì´í„°:", data.node.data);

					// ğŸ”¥ ëª¨ë“  í•˜ì´ë¼ì´íŠ¸ ì´ˆê¸°í™” (ê²€ìƒ‰ëœ ë…¸ë“œ ë°°ê²½ ì œê±°)
					$("#orgTree .fancytree-title").css("background", "");


					if (data.node.data && data.node.data.type === 'department') {
					    $("#detailTitle").text("ë¶€ì„œ ì •ë³´");
					    var contentHtml = ""
					        + "<p><strong>ë¶€ì„œëª…:</strong> " + (data.node.data.departmentName || "") + "</p>"
					        + "<p><strong>ë¶€ì„œì¥:</strong> " + (data.node.data.deptHeadName || "") + "</p>"
					        + "<p><strong>ë¶€ì„œ ìœ„ì¹˜:</strong> " + (data.node.data.departmentLocation || "") + "</p>"
					        + "<p><strong>ì „í™”ë²ˆí˜¸:</strong> " + (data.node.data.departmentPhonenumber || "") + "</p>"
					        + "<p><strong>íŒ©ìŠ¤ë²ˆí˜¸:</strong> " + (data.node.data.departmentFaxnumber || "") + "</p>";

					    if (hasHRRole) {
					        contentHtml += "<div style='text-align: right; margin-top: 10px;'>"
					            + "<button id='insertDeptBtn' class='btn btn-primary' style='margin-right: 5px;'>ë¶€ì„œ ì¶”ê°€</button>"
					            + "<button id='updateDeptBtn' class='btn btn-primary' style='margin-right: 5px;'>ë¶€ì„œ ìˆ˜ì •</button>"
					            + "<button id='deleteDeptBtn' class='btn btn-danger'>ë¶€ì„œ ì‚­ì œ</button>"
					            + "</div>";
					    }

					    $("#detailContent").html(contentHtml);
					    $("#detailPane").show();

					    $("#insertDeptBtn").click(function() {
					        window.location.href = window.contextPath + "/department/register?departmentId=" + data.node.data.departmentId;
					    });

					    $("#updateDeptBtn").click(function() {
					        window.location.href = window.contextPath + "/department/update?departmentId=" + data.node.data.departmentId;
					    });

					    $("#deleteDeptBtn").click(function() {
					        Swal.fire({
					            html: '<h2 style="font-size: 24px;">ì‚­ì œí•œ ë¶€ì„œëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤<br>ì„ íƒí•œ ë¶€ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>',
					            icon: "warning",
					            showCancelButton: true,
					            confirmButtonColor: "#435ebe",
					            cancelButtonColor: "#d33",
					            confirmButtonText: "ì‚­ì œ",
					            cancelButtonText: "ì·¨ì†Œ"
					        }).then((result) => {
					            if (result.isConfirmed) {
					                $.ajax({
					                    url: window.contextPath + "/department/deleteone",
					                    type: "POST",
					                    contentType: "application/json",
					                    data: JSON.stringify(data.node.data.departmentId),
					                    dataType: "json",
					                    success: function(response) {
					                        if (response.success) {
					                            Swal.fire({
					                                title: "ì‚­ì œ ì™„ë£Œ",
					                                text: "ë¶€ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.",
					                                icon: "success",
					                                confirmButtonText: "í™•ì¸"
					                            }).then(() => {
					                                location.reload();
					                            });
					                        } else {
					                            Swal.fire({
					                                title: "ì‚­ì œ ì‹¤íŒ¨",
					                                text: "ë¶€ì„œì›ì´ ìˆëŠ” ë¶€ì„œëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
					                                icon: "error",
					                                confirmButtonText: "í™•ì¸"
					                            });
					                        }
					                    },
					                    error: function(xhr, status, error) {
					                        Swal.fire({
					                            title: "ì‚­ì œ ì‹¤íŒ¨",
					                            text: "ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
					                            icon: "error",
					                            confirmButtonText: "í™•ì¸"
					                        });
					                        console.error("Error:", error);
					                    }
					                });
					            }
					        });
					    });
						} else if (data.node.data && data.node.data.type === 'team') {
						    $("#detailTitle").text("íŒ€ ì •ë³´");
						    var contentHtml = ""
						        + "<p><strong>íŒ€ëª…:</strong> " + (data.node.data.teamName || "") + "</p>"
						        + "<p><strong>ì „í™”ë²ˆí˜¸:</strong> " + (data.node.data.teamPhonenumber || "") + "</p>"
						        + "<p><strong>íŒ©ìŠ¤ë²ˆí˜¸:</strong> " + (data.node.data.teamFaxnumber || "") + "</p>";

						    if (hasHRRole) {
						        contentHtml += "<div style='text-align: right; margin-top: 10px;'>"
						            + "<button id='insertTeamBtn' class='btn btn-primary' style='margin-right: 5px;'>íŒ€ ì¶”ê°€</button>"
						            + "<button id='updateTeamBtn' class='btn btn-primary' style='margin-right: 5px;'>íŒ€ ìˆ˜ì •</button>"
						            + "<button id='deleteTeamBtn' class='btn btn-danger'>íŒ€ ì‚­ì œ</button>"
						            + "</div>";
						    }

						    $("#detailContent").html(contentHtml);
						    $("#detailPane").show();

						    $("#insertTeamBtn").click(function() {
						        window.location.href = window.contextPath + "/team/register?teamId=" + data.node.data.teamId;
						    });

						    $("#updateTeamBtn").click(function() {
						        window.location.href = window.contextPath + "/team/update?teamId=" + data.node.data.teamId;
						    });

						    $("#deleteTeamBtn").click(function() {
						        var teamId = data.node.data.teamId;
						        if (!teamId) {
						            Swal.fire({
						                title: "ì‚­ì œ ì‹¤íŒ¨",
						                text: "ì‚­ì œí•  íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.",
						                icon: "error",
						                confirmButtonText: "í™•ì¸"
						            });
						            return;
						        }
						        Swal.fire({
						            html: '<h2 style="font-size: 24px;">ì„ íƒí•œ íŒ€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>',
						            icon: "warning",
						            showCancelButton: true,
						            confirmButtonColor: "#435ebe",
						            cancelButtonColor: "#d33",
						            confirmButtonText: "ì‚­ì œ",
						            cancelButtonText: "ì·¨ì†Œ"
						        }).then((result) => {
						            if (result.isConfirmed) {
						                $.ajax({
						                    url: window.contextPath + "/team/deleteone",
						                    type: "POST",
						                    contentType: "application/json",
						                    data: JSON.stringify(teamId),
						                    dataType: "json",
						                    success: function(response) {
						                        if (response.success) {
						                            Swal.fire({
						                                title: "ì‚­ì œ ì™„ë£Œ",
						                                text: "íŒ€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.",
						                                icon: "success",
						                                confirmButtonText: "í™•ì¸"
						                            }).then(() => {
						                                location.reload();
						                            });
						                        } else {
						                            Swal.fire({
						                                title: "ì‚­ì œ ì‹¤íŒ¨",
						                                text: "íŒ€ì›ì´ ìˆëŠ” íŒ€ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
						                                icon: "error",
						                                confirmButtonText: "í™•ì¸"
						                            });
						                        }
						                    },
						                    error: function(xhr, status, error) {
						                        Swal.fire({
						                            title: "ì‚­ì œ ì‹¤íŒ¨",
						                            text: "ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
						                            icon: "error",
						                            confirmButtonText: "í™•ì¸"
						                        });
						                        console.error("Error:", error);
						                    }
						                });
						            }
						        });
						    });
                    } else if (data.node.data && data.node.data.type === 'employee') {
                        $("#detailTitle").text("ì§ì› ì •ë³´");
                        $("#detailContent").html(
                            "<p><strong>ì´ë¦„:</strong> " + (data.node.data.name || "") + "</p>" +
                            "<p><strong>ë¶€ì„œ:</strong> " + (data.node.data.dept || "") + "</p>" +
                            "<p><strong>ì§ì±…:</strong> " + (data.node.data.job || "") + "</p>" +
							"<p><strong>ì§ê¸‰:</strong> " + (data.node.data.rank || "") + "</p>" +
                            "<p><strong>ì´ë©”ì¼:</strong> " + (data.node.data.email || "") + "</p>" +
                            "<p><strong>ì „í™”ë²ˆí˜¸:</strong> " + (data.node.data.phone || "") + "</p>" +
                            "<p><strong>ì£¼ì†Œ:</strong> " + (data.node.data.address || "") + "</p>"
                        );
                        $("#detailPane").show();
                    } else {
                        $("#detailPane").hide();
                    }
                }
            });

			// **ì¤‘ë³µ ë“±ë¡ ë°©ì§€**: ê¸°ì¡´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ëª¨ë‘ off() í•œ ë’¤ ìƒˆë¡œ on()
            $("#empSearchBtn").off("click");
            $("#empSearchInput").off("keypress");
            $("#collapseAllBtn").off("click");
            $("#openAllBtn").off("click");

            // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
            $("#empSearchBtn").on("click", function () {
                const keyword = $("#empSearchInput").val().trim();
                if (keyword) searchAndExpandTree(keyword);
            });

            // ì—”í„°í‚¤ ì…ë ¥ ì‹œ ê²€ìƒ‰
            $("#empSearchInput").on("keypress", function (e) {
                if (e.which === 13) {
                    $("#empSearchBtn").click();
                }
            });

            // ì „ì²´ ì ‘ê¸° ë²„íŠ¼
            $("#collapseAllBtn").on("click", function () {
                $("#orgTree").fancytree("getTree").visit(function(node) {
                    node.setExpanded(false);
                });
            });

            // ì „ì²´ ì—´ê¸° ë²„íŠ¼
            $("#openAllBtn").on("click", function () {
                $("#orgTree").fancytree("getTree").visit(function(node) {
                    node.setExpanded(true);
                });
            });

			/**
			 * ì¡°ì§ë„ì—ì„œ ê²€ìƒ‰í•˜ì—¬ í•´ë‹¹ ë…¸ë“œë¥¼ í™•ì¥í•˜ê³  í•˜ì´ë¼ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
			 */
			function searchAndExpandTree(keyword) {
			    const lowerKeyword = keyword.toLowerCase();
			    let found = false;
			    const tree = $.ui.fancytree.getTree("#orgTree");

				// ğŸ”¥ ëª¨ë“  í•˜ì´ë¼ì´íŠ¸ ì´ˆê¸°í™”
				$("#orgTree .fancytree-title").css("background", "");

				tree.visit(function(node) {
				    const name = node.title.toLowerCase();
				    const dept = (node.data.departmentName || "").toLowerCase();
				    const team = (node.data.teamName || "").toLowerCase();

				    if (name.includes(lowerKeyword) || dept.includes(lowerKeyword) || team.includes(lowerKeyword)) {
				        found = true;

				        // ë¶€ëª¨ ë…¸ë“œë¥¼ ëª¨ë‘ í™•ì¥í•˜ì—¬ í•´ë‹¹ ë…¸ë“œê°€ ë³´ì´ë„ë¡ í•¨
				        node.visitParents(function(parent) {
				            parent.setExpanded(true);
				        });

				        // ğŸ”¥ ê²€ìƒ‰ëœ ë…¸ë“œ í•˜ì´ë¼ì´íŠ¸
				        $(node.span).find(".fancytree-title").css("background", "#ffff99");

				        // í•´ë‹¹ ë…¸ë“œë¡œ ìŠ¤í¬ë¡¤ ì´ë™
				        node.makeVisible();
				    }
				});

			    if (!found) {
			        alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
			    }
			}




		  // ğŸ”¥ ì—¬ê¸° ì¶”ê°€! (FancyTree ì´ˆê¸°í™” í›„ ì‹¤í–‰)
	      var tree = $("#orgTree").fancytree("getTree");

	      // ì €ì¥ëœ ì—´ë¦° ë…¸ë“œ ë³µì›
	      var expandedNodes = JSON.parse(localStorage.getItem("expandedNodes")) || [];
	      tree.visit(function(node) {
	          if (expandedNodes.includes(node.key)) {
	              node.setExpanded(true);
	          }
	      });

	      // ë…¸ë“œê°€ ì—´ë¦¬ê±°ë‚˜ ë‹«í ë•Œ ìƒíƒœ ì €ì¥
	      tree.$div.on("fancytreeexpand fancytreecollapse", function(event, data) {
	          var openNodes = [];
	          tree.visit(function(node) {
	              if (node.isExpanded()) {
	                  openNodes.push(node.key);
	              }
	          });
	          localStorage.setItem("expandedNodes", JSON.stringify(openNodes));
	      });

	  },

        error: function(xhr, status, error) {
            console.error("Ajax ìš”ì²­ ì‹¤íŒ¨:", status, error);
        }
    });
});


function processOrgData(departmentList) {
    var orgData = [];
    if (!Array.isArray(departmentList)) {
        console.error("departmentList í˜•ì‹ ì˜¤ë¥˜:", departmentList);
        return orgData;
    }
    departmentList.forEach(function(dept) {
		var deptName = dept.departmentName + (dept.departmentEmployeeCount ? " (" + dept.departmentEmployeeCount + "ëª…)" : "");
         deptNode = {
            title: deptName,
            folder: true,
            expanded: false,
            icon: "fas fa-building",
            data: {
                type: 'department',
                departmentId: dept.departmentId,
                departmentName: dept.departmentName,
                deptHeadName: dept.deptHeadName,
                departmentLocation: dept.departmentLocation,
                departmentPhonenumber: dept.departmentPhonenumber,
                departmentFaxnumber: dept.departmentFaxnumber
            },
            children: []
        };

        if (dept.teams && Array.isArray(dept.teams)) {
            dept.teams.forEach(function(team) {
				var teamEmpName = team.teamName + (team.teamEmployeeCount ? " (" + team.teamEmployeeCount + "ëª…)" : "");
                 teamNode = {
                    title: teamEmpName,
                    folder: true,
                    expanded: false,
                    icon: "fas fa-users",
                    data: {
                        type: 'team',
                        teamId: team.teamId,
                        teamName: team.teamName,
                        teamPhonenumber: team.teamPhonenumber,
                        teamFaxnumber: team.teamFaxnumber
                    },
                    children: []
                };

                if (team.employees && Array.isArray(team.employees)) {
                    team.employees.forEach(function(emp) {
						// emp.rankê°€ ì¡´ì¬í•˜ë©´ ê´„í˜¸ ì•ˆì— í‘œì‹œ, ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì´ë¦„ë§Œ í‘œì‹œ
						var displayName = emp.name + (emp.rank && emp.rank.rankName ? " (" + emp.rank.rankName + ")" : "");
                        teamNode.children.push({
                            title: displayName,
                            icon: "fas fa-user",
                            data: {
                                type: 'employee',
                                name: emp.name,
                                dept: dept.departmentName,
                                job: (emp.job && emp.job.jobName) ? emp.job.jobName : "",
                                rank: (emp.rank && emp.rank.rankName) ? emp.rank.rankName : "",
                                email: emp.email || "",
                                phone: emp.phoneNumber || "",
                                address: emp.address || ""
                            }
                        });
                    });
                }

                if (teamNode.children.length > 0) {
                    deptNode.children.push(teamNode);
                }
            });
        }

        if (dept.employees && Array.isArray(dept.employees)) {
            dept.employees.forEach(function(emp) {
                deptNode.children.push({
                    title: emp.name,
                    icon: "fas fa-user",
                    data: {
                        type: 'employee',
						name: emp.name,
                        dept: dept.departmentName,
                        job: (emp.job && emp.job.jobName) ? emp.job.jobName : "",
                        rank: (emp.rank && emp.rank.rankName) ? emp.rank.rankName : "",
                        email: emp.email || "",
                        phone: emp.phoneNumber || "",
                        address: emp.address || ""
                    }
                });
            });
        }

        if (deptNode.children.length > 0) {
            orgData.push(deptNode);
        }
    });
    return orgData;
}
