<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib uri="http://www.springframework.org/security/tags"
	prefix="security"%>
<!--
 * == ê°œì •ì´ë ¥(Modification Information) ==
 *
 *   ìˆ˜ì •ì¼               ìˆ˜ì •ì           ìˆ˜ì •ë‚´ìš©
 *  ============      ============== =======================
 *  2025-03-12          ì •íƒœìš°            ìµœì´ˆ ìƒì„±
 *  2025-03-14          ì •íƒœìš°            ì¶œê·¼ í‡´ê·¼ ì¼í•œì‹œê°„ ì‚½ì…
 *  2025-03-17          ì´ì˜ì¤€            securityì¬ ì„¤ì • ì„¸ì…˜ê°’ ë³€ê²½
 *  2025-04-02 			ìµœìœ¤ì‹			ê²°ì¬ëŒ€ê¸°í•¨ ë°ì´í„°í…Œì´ë¸”ìˆ˜ì •
-->
<style>
.same-size-btn {
    height: 40px;
    padding: 6px 12px;
    font-size: 1rem;
    line-height: 1.5;
}
.color-circle {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    border: 1px solid #ccc;
    vertical-align: middle;
}
/* FullCalendar ì œëª©(ì˜ˆ: 2025ë…„ 4ì›”) í¬ê¸° ì¤„ì´ê¸° */
.fc .fc-toolbar-title {
  font-size: 16px;     /* â† ì›ë˜ëŠ” 20~24px ì •ë„ì•¼. ì¤„ì´ê³  ì‹¶ìœ¼ë©´ 16px ì´í•˜ë¡œ! */
  font-weight: 500;    /* ê¸€ì ë‘ê»˜ ì¡°ì ˆ */
}

/* ë²„íŠ¼ í…ìŠ¤íŠ¸ ê°„ê²©ì´ë‚˜ í™”ì‚´í‘œ ê°„ê²©ë„ ì¡°ì ˆí•˜ê³  ì‹¶ìœ¼ë©´ */
.fc .fc-button .fc-icon {
  font-size: 10px;
}

/* FullCalendar ë²„íŠ¼ í¬ê¸° ì¡°ì ˆ */
.fc .fc-button {
  padding: 4px 2px;         /* ìƒí•˜, ì¢Œìš° ì—¬ë°± */
  font-size: 12px;          /* ê¸€ì í¬ê¸° ì¤„ì´ê¸° */
  height: 28px;             /* ë†’ì´ ì„¤ì • */
  line-height: 1.2;         /* ê¸€ì ì„¸ë¡œ ì •ë ¬ */
  border-radius: 4px;       /* ë²„íŠ¼ ë‘¥ê¸€ê¸° */
}

  #calendar {
    width: 100%;        /* ë¶€ëª¨ div ê½‰ ì±„ìš°ê¸° */
    height: 480px;      /* ë†’ì´ ì§ì ‘ ì§€ì • */
    margin: 0 auto;     /* ê°€ìš´ë° ì •ë ¬ */
  }
  .scrollable-list {
    max-height: 300px;  /* ë†’ì´ ê³ ì • */
    overflow-y: auto;   /* ë‚´ìš© ë§ìœ¼ë©´ ìŠ¤í¬ë¡¤ */
  }

  .widget-todo {
    height: 570px;       /* ì¹´ë“œ ì „ì²´ ë†’ì´ ê³ ì • */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

  .widget-todo h5 {
    margin-bottom: 1rem;
  }

  .widget-todo .list-group {
    flex-grow: 1;
  }
h4{
text-align: center;
}
.workStatusBtnArea {
  margin-left: 80px;        /* ì¢Œì¸¡ ì—¬ë°± ìë™ */
}
/* ì¶œê·¼ ì‹œê°„ ë° í‡´ê·¼ ì‹œê°„ í…ìŠ¤íŠ¸ì— ëŒ€í•œ ìŠ¤íƒ€ì¼ */
#startTime, #endTime, #workTime {
  font-size: 18px;
  font-weight: bold;
  color: #25396f; /* ì›í•˜ëŠ” ìƒ‰ìƒ ì ìš© */
  margin-bottom: 5px;
  margin-left: 20px; /* ì™¼ìª½ìœ¼ë¡œ ë°€ê¸° ìœ„í•œ ì—¬ë°± ì¶”ê°€ */
}

/* ê³µì§€ì‚¬í•­ ë° ê²°ì¬ ëŒ€ê¸°í•¨ ìŠ¤íƒ€ì¼ */
.section {
    background: #ffffff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* time-info í´ë˜ìŠ¤ì— ì¶”ê°€ ìŠ¤íƒ€ì¼ì„ ì¤„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤ */
.time-info {
  font-size: 16px;
  color: #34495E;
  padding: 3px 0;
}

.small-chart {
  width: 300px !important;  /* ì›í•˜ëŠ” ë„ˆë¹„ë¡œ ìˆ˜ì • */
  height: 300px !important; /* ì›í•˜ëŠ” ë†’ì´ë¡œ ìˆ˜ì • */
}
/* ì‹œê°„ ì •ë³´ ìŠ¤íƒ€ì¼ */
.time-info {
	display: block;
	font-size: 16px;
	color: #333; /* ê¸€ììƒ‰ */
	margin-bottom: 2px;
}

.workDuration {
	font-weight: bold;
}

/* ì¶”ê°€ ìŠ¤íƒ€ì¼: ê°„ê²©ê³¼ ì •ë ¬ */
span {
	display: inline-block;
	margin-left: 20px;
}

.card {
	border-radius: 10px;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
	background-color: #fff;
	padding: 20px;
}

.card-header {
	background-color: #f8f9fa;
	padding: 10px 15px;
	border-bottom: 1px solid #ddd;
	font-weight: bold;
}

.card-body {
	padding: 15px;
}

.time-info {
	font-size: 14px;
	color: #555;
}

.workDuration {
	font-weight: bold;
	color: #333;
}

.btn-outline-info {
	border-radius: 5px;
	font-size: 14px;
	margin-top: 10px;
	padding: 8px;
	border: 1px solid #ddd;
}

tbody {
	white-space: nowrap;
}

.todo-item {
	border: 1px solid #ddd;
	border-radius: 5px;
	padding: 10px;
	margin-bottom: 10px;
}

.todo-title {
    font-size: 1.2rem;
    font-weight: bold;
}

.scrollable-list {
    max-height: 400px; /* ì›í•˜ëŠ” ë†’ì´ë¡œ ì¡°ì • (ì˜ˆ: 400px) */
    overflow-y: auto;  /* ìˆ˜ì§ ìŠ¤í¬ë¡¤ë°” ìë™ ìƒì„± */
}

    .todo-item {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
    }
    .todo-title {
        font-size: 1.2rem;
        font-weight: bold;
    }
    .todo-date {
        color: #777;
        font-size: 0.9rem;
    }
    .todo-context {
        margin-top: 5px;
    }
    /* ê³ ì • ì˜ì—­: ìŠ¤í¬ë¡¤í•´ë„ ì›€ì§ì´ì§€ ì•Šë„ë¡ sticky ì†ì„± ì ìš© */
    .fixed-todo {
        position: sticky;
        top: 20px; /* ì›í•˜ëŠ” ê°„ê²©(ì˜ˆ: 20px) */
    }
    /* ë¦¬ìŠ¤íŠ¸ ì˜ì—­ì— ìµœëŒ€ ë†’ì´ë¥¼ ì§€ì •í•˜ê³  ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ í•  ìˆ˜ ìˆìŒ (í•„ìš”ì‹œ)
    .scrollable-list {
        max-height: 400px;
        overflow-y: auto;
    }
    */

.todo-title {
	font-size: 1.2rem;
	font-weight: bold;
}

.todo-date {
	color: #777;
	font-size: 0.9rem;
}

.todo-context {
	margin-top: 5px;
}
</style>
<!--ê·¼ë¬´ ì‹œê°„ ì°¨íŠ¸  -->
<script src="${pageContext.request.contextPath}/resources/js/chart/attantanceChart.js"></script>
<!-- ì „ìê²°ì¬ -> ë‚´ ë¬¸ì„œ ì°¨íŠ¸ -->
<script src="${pageContext.request.contextPath}/resources/js/approval/approverChartStatusCount.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/approval/approverChart.js"></script>

<c:url var="logoutUrl" value="/account/login/logout"/>
<security:authentication property="principal" var="principal" />
<label> 
		<input type="checkbox" id="alarmToggle"> ì•Œë¦¼ ë°›ê¸°
	</label>

<div id="main" class="layout-horizontal">
	<header class="mb-3">
		<a href="#" class="burger-btn d-block d-xl-none"> <i
			class="bi bi-justify fs-3"></i>
		</a>
	</header>
	<div class="page-content">
		<section class="row">
			<!-- ìº˜ë¦°ë” ì™¼ìª½ -->
<!-- 			<div class="col-12 col-lg-4"> -->
<!-- 				<div class="card" > -->
<%-- 					<script src="${pageContext.request.contextPath}/resources/fullcalendar-6.1.15/dist/index.global.js"></script> --%>
<!-- 					<div id="calendar"></div> -->
<!-- 				</div> -->
<!-- 			</div> -->



			<div class="col-12 col-lg-3">
				<div class="card" style="height: 570px;">
					<div id="desc">
<!-- 						<div class="color-circle" style="background-color: black;"></div> : <strong style="color: black;">ì „ì²´ì¼ì •</strong> -->
						<div class="color-circle" style="background-color: green;"></div> : <strong style="color: green;">ê°œì¸ì¼ì •</strong>
					</div>
					<div id="calendar"></div>
				</div>
			</div>


			<div class="col-12 col-lg-3">
			  <div class="card-content pb-4">
			    <div class="card widget-todo">
			      <h5>ì´ë²ˆì£¼ ë‚´ í•  ì¼</h5>
			      <div class="list-group scrollable-list">
			        <c:choose>
			          <c:when test="${not empty scheduleList}">
			            <c:forEach var="schedule" items="${scheduleList}">
			              <fmt:parseDate var="parsedStartDate" value="${schedule.startDate}" pattern="yyyy-MM-dd HH:mm:ss" />
			              <div class="todo-item list-group-item">
			                <div class="todo-title">${schedule.scheduleTitle}</div>
			                <div class="todo-context mt-2">${schedule.scheduleContext}</div>
			              </div>
			            </c:forEach>
			          </c:when>
			          <c:otherwise>
			            <p>ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
			          </c:otherwise>
			        </c:choose>
			      </div>
			    </div>
			  </div>
			</div>

			  <!-- ë‚¨ì€ ê·¼ë¬´ ì‹œê°„ë§Œ ë³´ì—¬ì£¼ëŠ” ë„ë„› ì°¨íŠ¸ -->
<!-- 			  <div class="col-12 col-lg-3"> -->
<!-- 			    <div class="container"> -->
<!-- 			      <div class="summary"> -->
<!-- 			        <div class="card"> -->
<!-- 			          <input type="hidden" id="monthRemain"/> -->
<%-- 			          <canvas id="remainchart" class="small-chart" style="height: 300px;"></canvas> --%>
<!-- 			        </div> -->
<!-- 			      </div> -->
<!-- 			    </div> -->
<!-- 			  </div> -->
<!-- 			</div> -->


		<input type="hidden" value="${employee.empId}" id="empId" />
			<div class="col-12 col-lg-3">
				<div class="container">
				    <div class="summary">
						<div class="card" style="height:570px; display: flex; justify-content: center; align-items: center;">
						    <input type="hidden" id="monthTotal"/>
						    <canvas id="totalchart" style="width: 300px; height: 300px;"></canvas>
						</div>
				    </div>
				</div>
			</div>

<!-- ìƒëŒ€ ê²½ë¡œ ì¶”ì¶œ -->
<c:set var="fullPath" value="${employee.empPath}" />
<c:set var="startIndex" value="${fn:indexOf(fullPath, 'fileImages')}" />
<c:set var="cutStart" value="${startIndex + 10}" />
<c:set var="cutEnd" value="${fn:length(fullPath)}" />
<c:set var="fileName" value="${fn:substring(fullPath, cutStart, cutEnd)}" />
<c:set var="webPath" value="/resources/fileImages/${fileName}" />

			<!-- ìº˜ë¦°ë” ì˜¤ë¥¸ìª½ (í”„ë¡œí•„ ì •ë³´) -->
			<div class="col-12 col-lg-3">
				<div class="card">
					<div class="card-body py-4 px-5">
						<div class="d-flex align-items-center">
							<div class="avatar avatar-xl">
								<img
									src="${pageContext.request.contextPath}${webPath}"
									alt="ì§ì› í”„ë¡œí•„">
							</div>
							<div class="ms-3 name">
								<h6>${principal.realUser.department.departmentName}<br>
									${principal.realUser.employee.team.teamName}</h6>
								<h5 class="text-muted mb-0">${principal.realUser.empName }
									${principal.realUser.rank.rankName }</h5>

								<a href="${logoutUrl}" id="logoutLink">ë¡œê·¸ì•„ì›ƒ</a>
							</div>
						</div>
					</div>
				</div>
				<div class="card">
					<div class="card-header">
						<h4>ë‚˜ì˜ ê·¼íƒœ</h4>
					</div>
						<h6>
							<span id="time"></span>
						</h6>
						<c:if test="${not empty sessionAccount.attendance}">
							<c:forEach items="${sessionAccount.attendance}" var="attendance">
								<span id="startTime" class="time-info">ì¶œê·¼ ì‹œê°„: <strong>${attendance.workStartTime}</strong></span>
								<br />
								<span id="endTime" class="time-info">í‡´ê·¼ ì‹œê°„: <strong>${attendance.workEndTime}</strong></span>
								<br />
								<span id="workTime">ì¼í•œ ì‹œê°„:
								<span class="workDuration"
									data-workstart="${attendance.workStartTime}"
									data-workend="${attendance.workEndTime}"> </span>
								</span>
								<br />
							</c:forEach>
						</c:if>
						<c:if test="${empty sessionAccount.attendance}">
							<span id="startTime">ì¶œê·¼ ì‹œê°„ </span>
							<br />
							<span id="endTime">í‡´ê·¼ ì‹œê°„ </span>
							<br />
							<span id="workTime">ì¼í•œ ì‹œê°„ </span>
							<br />
						</c:if>
							<svg width="100%" height="5">
							  <line x1="0" y1="2.5" x2="100%" y2="2.5" stroke="#ccc" stroke-dasharray="4,4"/>
							</svg>

					<div class="workStatusBtnArea" style="margin: auto;">
					    <a class="btn btn-outline-info same-size-btn"
					        href="${pageContext.request.contextPath}/generate-qr"
					        data-bs-toggle="modal" data-bs-target="#exampleModal__">ì¶œ/í‡´QR</a>

					    <select id="workStatusSelect" name="workStatus"
					        onchange="updateWorkStatus()"
					        class="btn btn-outline-info same-size-btn">
					        <c:forEach items="${workStatusList}" var="workStatusVO">
					            <c:if test="${workStatusVO.statusPos eq 'Y'}">
					                <option value="${workStatusVO.statusId}"
					                    ${workStatusVO.statusId eq workStatus.statusId ? 'selected' : ''}
					                    ${workStatus.statusId eq 'STAT_03' && workStatusVO.statusId ne 'STAT_03' ? 'disabled' : ''}>
					                    ${workStatusVO.statusName}
					                </option>
					            </c:if>
					        </c:forEach>
					    </select>
					</div>
				</div>
			</div>
		</section>

		<section class="row">
			<!-- ê²Œì‹œíŒ (ì™¼ìª½) -->
			<div class="col-12 col-lg-5">
				<section class="section">
						<div class="card-header">
							<h4 class="card-title">
								<a href="${pageContext.request.contextPath }/board/list"
									class="text-decoration-none text-grey">ê³µì§€ì‚¬í•­</a>
							</h4>
						</div>
						<div class="card-body">
							<div class="list-group scrollable-list">
								<!-- ë°ì´í„° í…Œì´ë¸”ì„ ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸° -->
								<div class="table-responsive" style="max-width: 100%; overflow-x: auto;">
									<table id="table1" class="table table-striped datatable">
										<thead>
											<tr>
												<th data-sortable=""><a href="#"
													class="dataTable-sorter">ì œëª©</a></th>
												<th data-sortable=""><a href="#"
													class="dataTable-sorter">ì‘ì„±ì¼</a></th>
											</tr>
										</thead>
										<tbody>
											<c:choose>
												<c:when test="${not empty boardList}">
													<c:forEach items="${boardList}" var="board">
														<tr>
															<td><a href="javascript:void(0);"
																onclick="navigateToDetail('${board.noticeId}')">${board.title}</a>
															</td>
															<td>${board.createdAt}</td>
														</tr>
													</c:forEach>
												</c:when>
												<c:otherwise>
													<tr>
														<td colspan="6">ê³µì§€ê¸€ ì—†ìŒ.</td>
													</tr>
												</c:otherwise>
											</c:choose>
										</tbody>
									</table>
								</div>
							</div>
						</div>
				</section>
			</div>

			<!-- ê²Œì‹œíŒ ì˜¤ë¥¸ìª½ (appoverProcess.jsp) -->
			<div class="col-12 col-lg-7">
				<section class="section" style="height: 520px;">
						<div class="card-header">
							<h4 class="card-title">
								<a href="${pageContext.request.contextPath }/approval/templateList">ì „ìê²°ì¬</a>
							</h4>
						</div>
						<div class="card-body">
						  <div class="row">
						    <!-- ë¬¸ì„œ ìƒíƒœ ì°¨íŠ¸ -->
						    <div class="col-md-6">
						    <div class="data-visualization">
						      <div class="chart-container" style="width: 100%; height: 350px;">
						        <h4 class="text-center mb-3">ê¸°ì•ˆ ë¬¸ì„œ </h4>
						        <canvas id="statusChart" style="width: 100%; height: 100%;"></canvas>
						        </div>
						      </div>
						    </div>
						    <!-- ê²°ì¬ ìƒíƒœ ì°¨íŠ¸ -->
						    <div class="col-md-6">
						      <div class="data-visualization">
						      <div class="chart-container" style="width: 100%; height: 350px;">
						        <h4 class="text-center mb-3">ê²°ì¬ ë¬¸ì„œ</h4>
						        <canvas id="statusApprChart" style="width: 100%; height: 100%;"></canvas>
						        </div>
						      </div>
						    </div>
						  </div>
						</div>

						</section>
						</div>
				</section>
			</div>
		</section>
	</div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal__" tabindex="-1"
	aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="exampleModalLabel">ì¶œí‡´ê·¼ QR</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body"></div>
		</div>
	</div>
</div>

<!-- íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ í•  ì¼ ì¶”ê°€ ëª¨ë‹¬ ì°½ -->
<div class="modal fade" id="taskModal" tabindex="-1"
	aria-labelledby="taskModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="taskModalLabel">í•  ì¼ ì¶”ê°€</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="form-group">
					<label for="taskInput" class="form-label">í•  ì¼ ì…ë ¥</label>
					<textarea class="form-control" id="taskInput" rows="3"></textarea>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary"
					data-bs-dismiss="modal">ë‹«ê¸°</button>
				<button type="button" class="btn btn-primary" id="saveTask">ì €ì¥</button>
			</div>
		</div>
	</div>
</div>

<!-- Simple DataTables ìŠ¤í¬ë¦½íŠ¸ -->
<script
	src="${pageContext.request.contextPath}/resources/js/content/appMain.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script
	src="${pageContext.request.contextPath}/resources/js/qr/qrModal.js"></script>
<script
	src="${pageContext.request.contextPath}/resources/js/content/updateTime.js"></script>
<script
	src="${pageContext.request.contextPath}/resources/js/content/updateWorkedTime.js"></script>
<script
	src="${pageContext.request.contextPath}/resources/js/qr/qrWorkStatusUpdate.js"></script>
<script
	src="${pageContext.request.contextPath}/resources/js/test.js"></script>
<script>
	var empId = '${principal.realUser.empId}'; //ë¡œê·¸ì¸í•œ ì‚¬ì›ì˜ Id
	var logoutUrl = '${logoutUrl}';
	console.log("empId",empId)
   //í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ì‹œê°„ì„ ì—…ë°ì´íŠ¸í•˜ê³ , 1ì´ˆë§ˆë‹¤ ê°±ì‹ 
   window.onload = function() {
      updateTime();
      updateWorkedTime();   // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°”ë¡œ ì‹¤í–‰
      setInterval(updateTime, 1000); // 1ì´ˆë§ˆë‹¤ ì‹œê°„ ê°±ì‹ 
      setInterval(updateWorkedTime, 1000);
      connectAndSendStatus();
   };

   function navigateToDetail(postId) {
       console.log("Navigating to detail with noticeId:", postId); // ë¡œê·¸ ì¶”ê°€
       window.location.href = "${pageContext.request.contextPath}/board/detail?noticeId=" + postId;
   }

   function updateWorkStatus() {
		var statusId = $('#workStatusSelect').val();  // ì„ íƒëœ ìƒíƒœ ID
		$.ajax({
			url: '/workstauts/updateWorkStatus',  // ì„œë²„ì˜ URL
			type: 'POST',
			data: {
				statusId: statusId,
				empId: empId,
				workDate: workDate
			},
			success: function(response) {
				alert('ì—…ë°ì´íŠ¸ ì„±ê³µ');
			},
			error: function() {
				alert('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
			}
		});
	}
   let stompClient = null;

   function connectAndSendStatus() {
       const socket = new SockJS('/wss');
       stompClient = Stomp.over(socket);

       stompClient.connect({}, function(frame) {
           console.log('ğŸŸ¢ WebSocket ì—°ê²°ë¨ (ë¡œê·¸ì¸ ìƒíƒœ ì•Œë¦¼ìš©)', frame);

           // ì˜¨ë¼ì¸ ìƒíƒœ ì„œë²„ì— ì „ì†¡
           stompClient.send("/app/status", {}, JSON.stringify({
               empId: empId,
               status: "ì˜¨ë¼ì¸"
           }));
       });
   }


   // 2) ë¡œê·¸ì•„ì›ƒ ë§í¬ í´ë¦­ í•¸ë“¤ëŸ¬
   $('#logoutLink').on('click', function(e){
     e.preventDefault();
     // ì˜¤í”„ë¼ì¸ ìƒíƒœ ì „ì†¡
     if (stompClient) {
       stompClient.send("/app/status", {}, JSON.stringify({
         empId: empId,
         status: "ì˜¤í”„ë¼ì¸"
       }));
     }
     // ì‹¤ì œ ë¡œê·¸ì•„ì›ƒ ì´ë™
     setTimeout(function(){
       window.location.href = logoutUrl;
     }, 300);
   });

   var scheduleList = [];
   <c:if test="${not empty scheduleList}">
       <c:forEach items="${scheduleList}" var="x">
           scheduleList.push({
               empId: "${x.empId}",
               scheduleTitle: "${x.scheduleTitle}",
               scheduleContext: "${x.scheduleContext}",
               startDate: "${x.startDate}",
               endDate: "${x.endDate}",
               scheduleVisibility: "${x.scheduleVisibility}",
               colorCode: "${x.colorCode}"
           });
       </c:forEach>
   </c:if>;
</script>

<!-- TodoList JS -->
<script>
$(document).ready(function(){
    var drake = dragula([document.getElementById("todoList")]);

    loadTasks(); // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°

    $('#addTaskBtn').click(function(){
        $('#taskModal').modal('show');
    });

    $('#saveTask').click(function(){
        var taskText = $('#taskInput').val().trim();
        if(taskText) {
            addTaskToList(taskText);
            saveTasks(); // âœ… í•  ì¼ ì €ì¥
            $('#taskInput').val("");
            $('#taskModal').modal('hide');
        }
    });

    $('#todoList').on('change', 'input[type="checkbox"]', function(){
        if(this.checked){
            $(this).closest('li').fadeOut(function(){
                $(this).remove();
                saveTasks(); // âœ… ì‚­ì œ í›„ ì €ì¥
            });
        }
    });

    function addTaskToList(taskText) {
        var newTask = $('<li class="list-group-item d-flex align-items-center"></li>');
        var listIcon = $('<i data-feather="list" class="cursor-move me-2" style="font-size: 20px;"></i>');

        var checkbox = $('<input type="checkbox" class="form-check-input me-2">');
        var label = $('<span></span>').text(taskText);

        newTask.append(listIcon).append(checkbox).append(label);
        $('#todoList').append(newTask);
        feather.replace();

        drake.destroy();
        drake = dragula([document.getElementById("todoList")]);
    }

    function saveTasks() {
        let tasks = [];
        $("#todoList li").each(function() {
            let text = $(this).find("span").text();
            tasks.push(text);
        });
        localStorage.setItem("todoTasks", JSON.stringify(tasks));
    }

    function loadTasks() {
        let savedTasks = localStorage.getItem("todoTasks");
        if (savedTasks) {
            savedTasks = JSON.parse(savedTasks);
            savedTasks.forEach(task => {
                addTaskToList(task);
            });
        }
    }
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {

    var scheduleList = [];
    <c:if test="${not empty scheduleList}">
        <c:forEach items="${scheduleList}" var="x">
            scheduleList.push({
            	scheduleId : "${x.scheduleId}",
                empId: "${x.empId}",
                empName : "${x.empName}",
                scheduleTitle: "${x.scheduleTitle}",
                scheduleContext: `${x.scheduleContext}`,
                startDate: "${x.startDate}",
                endDate: "${x.endDate}",
                scheduleVisibility: "${x.scheduleVisibility}",
                colorCode: "${x.colorCode}"
            });
        </c:forEach>
    </c:if>;

 	// ì €ì¥ì‹œ Title, desc ë„ê°’ ë°©ì§€
    document.querySelector("#insertButton")?.addEventListener("click", function() {
    	    // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
    	    const title = document.getElementById("inputTitle").value.trim();
    	    const desc = document.getElementById("inputDescription").value.trim();

    	    // ë„ê°’ ê²€ì‚¬
    	    if (!title || !desc ) {
    	        alert("ì œëª©ê³¼ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    	        return;
    	    }
    	    // ìœ íš¨ì„± í†µê³¼ ì‹œ í¼ submit
    	    document.getElementById("scheduleForm").submit();
    });

    // ì¼ì • ë“±ë¡í™”ë©´ì—ì„œ ì¼ì •ë³€ê²½ í•¨ìˆ˜
    document.querySelector("#inputEndDate")?.addEventListener("change", function() {
    	 let startDate = document.querySelector("#inputStartDate");
 	    let endDate = document.querySelector("#inputEndDate");
 	   var start = new Date(startDate.value);
	    var end = new Date(endDate.value);
	    var currentDate = new Date(start);


	    if (currentDate > end) {
	        alert("ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	        return;
	    }
    });

    let now = new Date();
    let formattedDate = now.toISOString().split('T')[0];

    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {

    	 locale: 'ko', // í•œêµ­ì–´
    	dateClick: function(info) {
    	    var clickedDate = info.dateStr;

    	    // í´ë¦­í•œ ë‚ ì§œì— í•´ë‹¹í•˜ëŠ” ì¼ì •ë“¤ì„ í•„í„°ë§
    	    var filteredSchedules = scheduleList.filter(function(event) {
    	        var eventStartDate = new Date(event.startDate);
    	        var eventEndDate = new Date(event.endDate);
    	        var clickedDateObj = new Date(clickedDate);
    	        return eventStartDate.toDateString() === clickedDateObj.toDateString();
    	    });

    	    // ë‚ ì§œë¥¼ ë™ì ìœ¼ë¡œ ì‚½ì…í•˜ê¸° ìœ„í•´ ëª¨ë‹¬ ë‚´ p íƒœê·¸ë¥¼ ìƒì„±
    	    var modalDate = document.getElementById('modalDate');
    	    modalDate.innerHTML = `ë‚ ì§œ: \${clickedDate}`;

    	    // ì¼ì • ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
    	    var scheduleListContainer = document.getElementById('scheduleList');
    	    scheduleListContainer.innerHTML = ''; // ì´ì „ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¹„ìš´ë‹¤

    	    if (filteredSchedules.length > 0) {
    	        filteredSchedules.forEach(function(schedule) {
    	            var listItem = document.createElement('li');
    	            listItem.classList.add('list-group-item');
    	            listItem.innerHTML = `
    	                <div class="schedule-item">
    	                    <div class="schedule-header">
    	                        <span class="schedule-empName">\${schedule.empName}</span>
    	                        <span class="schedule-title">\${schedule.scheduleTitle}</span>
    	                    </div>
    	                    <div class="schedule-details">
    	                        <div class="schedule-context">\${schedule.scheduleContext}</div>
    	                    </div>
    	                    <div class="schedule-dates">
    	                        <div class="schedule-dates-wrapper">
    	                            <span class="schedule-startDate">
    	                                <i class="fas fa-calendar-day"></i> \${schedule.startDate}
    	                            </span>
    	                            <span class="schedule-endDate">
    	                                <i class="fas fa-calendar-alt"></i> \${schedule.endDate}
    	                            </span>
    	                        </div>
    	                    </div>
    	                </div>
    	            `;
    	            scheduleListContainer.appendChild(listItem);
    	        });
    	    } else {
    	        scheduleListContainer.innerHTML = '<li class="list-group-item">ì´ ë‚ ì§œì—ëŠ” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
    	    }

    	    let startDate = document.querySelector("#inputStartDate");
    	    let endDate = document.querySelector("#inputEndDate");

			startDate.value = `\${clickedDate}T09:00`;
			endDate.value = `\${clickedDate}T18:00`;


    	    var start = new Date(startDate.value);
    	    var end = new Date(endDate.value);
    	    var currentDate = new Date(start);

    	    // í´ë¦­í•œ ë‚ ì§œê°€ ì¢…ë£Œì¼ ì „ì¸ì§€ í™•ì¸
    	    if (currentDate > end) {
    	        alert("ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    	        return;
    	    }

    	    // í´ë¦­ëœ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì—¬ëŸ¬ ë‚ ì§œì— ëŒ€í•´ ì¼ì • ì¶”ê°€
    	    var currentDate = new Date(startDate);
    	    while (currentDate <= end) {
    	        let currentFormattedDate = currentDate.toISOString().split('T')[0];

    	        // ìƒ‰ìƒ ì„ íƒì— ë”°ë¥¸ ìƒ‰ìƒ ì½”ë“œ ì„¤ì •
    	        let visibility = document.querySelector("#inputVisibility").value;
    	        let colorCode = visibility === 'P' ? '#000000' : '#2A9D8F';  // Pì™€ Dì— ë§ëŠ” ìƒ‰ìƒ ì„¤ì •
    	        // ì´ë²¤íŠ¸ ê°ì²´ ì¶”ê°€
    	        scheduleList.push({
    	            scheduleId: new Date().getTime(),  // unique scheduleId
    	            empId: "${principal.realUser.empId}",
    	            scheduleTitle: document.getElementById('inputTitle').value,
    	            scheduleContext: document.getElementById('inputDescription').value,
    	            startDate: currentFormattedDate + 'T00:00',
    	            endDate: currentFormattedDate + 'T23:59',
    	            scheduleVisibility: visibility,
    	            colorCode: colorCode
    	        });

    	        // ë‚ ì§œë¥¼ í•˜ë£¨ì”© ì¦ê°€
    	        currentDate.setDate(currentDate.getDate() + 1);
    	    }

    	    // ìº˜ë¦°ë”ì— ì´ë²¤íŠ¸ ì¶”ê°€
    	    calendar.addEventSource(scheduleList);

    	    // ëª¨ë‹¬ ë„ìš°ê¸°
    	    var myModal = new bootstrap.Modal(document.getElementById('exampleModal__'));
    	    myModal.show();
    	},

    	headerToolbar: {
    		  left: '',         // â† ì´ì „/ë‹¤ìŒ/ì˜¤ëŠ˜ ë²„íŠ¼ ì—†ì• ê¸°
    		  center: 'title',  // â† "2025ë…„ 4ì›”" ê°™ì€ ì œëª©ë§Œ ì¤‘ì•™ì— í‘œì‹œ
    		  right: ''         // â† ë³´ê¸° ì„ íƒ ë²„íŠ¼(ì›”/ì£¼/ì¼) ì—†ì• ê¸°
    		},

        initialDate: formattedDate,
        navLinks: true,
        editable: true,
        dayMaxEvents: true,
        events: scheduleList
        .filter(event => {
            const loggedInEmpId = '${principal.realUser.empId}';
            if (event.scheduleVisibility === 'P') return true;
            return event.empId === loggedInEmpId; //ì¼ì • ìƒíƒœê°€ Dì¼ ê²½ìš° ì‘ì„±ì ë‹¬ë ¥ì—ë§Œ ì¼ì •ì´ ëœ¸
        }).map(event => ({
        	empId : event.empId,
        	scheduleId : event.scheduleId,
            title: event.scheduleTitle,
            empName : event.empName,
            start: event.startDate,
            end: event.endDate,
            description: event.scheduleContext,
            backgroundColor: event.scheduleVisibility === 'P' ? 'black' : 'green',   // P -> black, D -> green
            borderColor: event.scheduleVisibility === 'P' ? 'black' : 'green',
            scheduleVisibility: event.scheduleVisibility
        })),
        eventTimeFormat: {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        },
        // ì¼ì •ì„ ë“œë˜ê·¸í•´ì„œ ì¼ì •ì„ ë³€ê²½ ê¸°ì¡´ ë°ì´í„°ë“¤ì€ ê·¸ëŒ€ë¡œ ê°€ì ¸ê°€ê³  ì¼ìë§Œ ë°”ë€œ
        eventDrop:function(info){
        	// ë³€ê²½ëœ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ì¶”ì¶œ
            let updatedStartDate = info.event.start.toLocaleString('sv-SE').slice(0, 16);
            let updatedEndDate = info.event.end.toLocaleString('sv-SE').slice(0, 16);
            let empId = info.event.extendedProps.empId;
            let title = info.event.title;
            let description = info.event.extendedProps.description;
            let scheduleVisibility = info.event.extendedProps.scheduleVisibility;
            const loggedInEmpId = '${principal.realUser.empId}';

            console.log(empId)
            console.log(loggedInEmpId)
            if (empId !== loggedInEmpId) {
            	// ë³¸ì¸ì´ ì•„ë‹ˆë©´ ì¼ì • ìˆ˜ì • ë¶ˆê°€
            	alert("ë‚¨ì˜ ì¼ì •ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                window.location.reload();
            	return;
            }

            // ì„œë²„ì— ì „ë‹¬í•  ë°ì´í„° ì¤€ë¹„ (ì´ë²¤íŠ¸ ID, ì‹œì‘ì¼, ì¢…ë£Œì¼)
            let updatedEventData = {
                scheduleId: info.event.extendedProps.scheduleId,  // ì¼ì • ID
                startDate: updatedStartDate,
                endDate: updatedEndDate,
                empId:empId,
                scheduleTitle:title,
                scheduleContext:description,
                scheduleVisibility:scheduleVisibility
            };
			console.log(updatedEventData)

            // Ajaxë¡œ ì„œë²„ì— ë°ì´í„° ì „ì†¡ (ì¼ì • ì—…ë°ì´íŠ¸)
            $.ajax({
                url: "/schedule/update",  // ì„œë²„ì—ì„œ ì²˜ë¦¬í•  URL (ìˆ˜ì •ëœ ì¼ì •ì„ ì²˜ë¦¬í•  URL)
                type: "POST",             // POST ë°©ì‹
                data: updatedEventData,   // ë³€ê²½ëœ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ë°ì´í„°ë¥¼ ì „ì†¡
                dataType: "json",         // ì‘ë‹µì„ JSONìœ¼ë¡œ ì²˜ë¦¬
                success: function(response) {
                    window.location.reload();
                },
                error: function(xhr, status, error) {
                    console.error(error);  // ì—ëŸ¬ ì¶œë ¥
                    alert("ì¼ì •ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    window.location.reload();
                }
            });

        },
        //ì¼ì •ì„ í´ë¦­í•˜ë©´ ìˆ˜ì •/ì‚­ì œ í•  ìˆ˜ ìˆëŠ” ëª¨ë‹¬ ì°½
        eventClick: function(info) {
            // ëª¨ë‹¬ì— í´ë¦­ëœ ì´ë²¤íŠ¸ ì •ë³´ ì±„ìš°ê¸°
            document.getElementById('editTitle').value = info.event.title;
            document.getElementById('editDescription').value = info.event.extendedProps.description || '';
            document.getElementById('editStartDate').value = info.event.start.toLocaleString('sv-SE').slice(0, 16);
            document.getElementById('editEndDate').value = info.event.end.toLocaleString('sv-SE').slice(0, 16);
            document.getElementById('updateVisibility').value = info.event.extendedProps.scheduleVisibility;
            document.getElementById('editScheduleId').value = info.event.extendedProps.scheduleId;
            const empId =  document.getElementById('editEmpId').value = info.event.extendedProps.empId;
            const loggedInEmpId = '${principal.realUser.empId}';

            if (empId === loggedInEmpId) {
                // ë³¸ì¸ì¼ ê²½ìš°ì—ë§Œ ë²„íŠ¼ ë³´ì´ê²Œ
                document.querySelector('#saveButton').style.display = 'inline-block';
                document.querySelector('#deleteEventButton').style.display = 'inline-block';
            } else {
                // ë³¸ì¸ì´ ì•„ë‹ˆë©´ ìˆ¨ê¹€
                document.querySelector('#saveButton').style.display = 'none';
                document.querySelector('#deleteEventButton').style.display = 'none';
            }

            // ìˆ˜ì •/ì‚­ì œ ëª¨ë‹¬ì„ ë„ìš´ë‹¤
            var myModal = new bootstrap.Modal(document.getElementById('editDeleteModal'));
            myModal.show();

            // ìˆ˜ì • í¼ ì œì¶œ ì‹œ ì¼ì • ìˆ˜ì •
            let updateForm = document.getElementById('editForm');

            // ìˆ˜ì •ëœ í¼ ë°ì´í„°ë¥¼ í¼ í•„ë“œì— ë°˜ì˜í•œ í›„ FormDataë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤
            updateForm.onsubmit = function(e) {
                e.preventDefault();
 				let formData = new FormData(updateForm);

                // Ajaxë¡œ ì„œë²„ì— ìˆ˜ì •ëœ ë°ì´í„° ì „ì†¡
                $.ajax({
                    url: updateForm.action,  // í¼ì˜ actionì„ ì‚¬ìš©
                    type: "post",            // POST ë°©ì‹
                    data: formData,          // FormDataë¥¼ ì „ì†¡
                    processData: false,      // jQueryê°€ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•Šë„ë¡ ì„¤ì • (FormDataëŠ” ì´ë¯¸ ì²˜ë¦¬ë¨)
                    contentType: false,      // jQueryê°€ content-typeì„ ì„¤ì •í•˜ì§€ ì•Šë„ë¡ ì„¤ì • (FormDataëŠ” ì´ë¯¸ ì„¤ì •ë¨)
                    dataType: "json",        // ì‘ë‹µ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ì²˜ë¦¬
                    success: function(data) {
                    	window.location.reload();
                    },
                    error: function() {
                        alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                });

                // ìˆ˜ì •ëœ ê°’ìœ¼ë¡œ ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
                info.event.setProp('title', document.getElementById('editTitle').value);
                info.event.setStart(document.getElementById('editStartDate').value);
                info.event.setEnd(document.getElementById('editEndDate').value);
                info.event.setExtendedProp('description', document.getElementById('editDescription').value);

                // ìˆ˜ì •ëœ ê³µê°œ ë²”ìœ„ì— ë§ëŠ” ìƒ‰ìƒ ë°˜ì˜
                var visibility = document.getElementById('updateVisibility').value;
                var color = visibility === 'P' ? 'blue' : 'green';
                info.event.setProp('backgroundColor', color);
                info.event.setProp('borderColor', color);

                myModal.hide();
            };

            // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
            document.getElementById('deleteEventButton').onclick = function() {

                let formData = new FormData(updateForm);

                // ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ë¨¼ì € ë„ìš°ê¸°
                Swal.fire({
                    title: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                    text: "ì‚­ì œëœ ì¼ì •ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'ì‚­ì œ',
                    cancelButtonText: 'ì·¨ì†Œ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // ìœ ì €ê°€ 'ì‚­ì œ' ëˆ„ë¥´ë©´ AJAX ìš”ì²­
                        $.ajax({
                            url: "/schedule/delete",
                            type: "post",
                            data: formData,
                            processData: false,
                            contentType: false,
                            dataType: "json",
                            success: function(data) {
                                // ìº˜ë¦°ë”ì—ì„œ ì´ë²¤íŠ¸ ì‚­ì œ
                                info.event.remove();

                                // ëª¨ë‹¬ ë‹«ê¸°
                                myModal.hide();

                                // âœ… SweetAlert2ë¡œ ì„±ê³µ ì•Œë¦¼
                                Swal.fire({
                                    icon: 'success',
                                    title: 'ì‚­ì œ ì™„ë£Œ',
                                    text: 'ì¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.',
                                    timer: 1500,
                                    showConfirmButton: false
                                });
                            },
                            error: function() {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'ì˜¤ë¥˜ ë°œìƒ',
                                    text: 'ì‚­ì œ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                                });
                            }
                        });
                    }
                });
            };
        }
    });

    calendar.render();
});
const toggle = document.getElementById("alarmToggle");

//ì €ì¥ëœ ì„¤ì • ë°˜ì˜
toggle.checked = localStorage.getItem("alarmEnabled") === "true";

//ì²´í¬ë°•ìŠ¤ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì €ì¥
toggle.addEventListener("change", function () {
 localStorage.setItem("alarmEnabled", this.checked);
});
</script>
