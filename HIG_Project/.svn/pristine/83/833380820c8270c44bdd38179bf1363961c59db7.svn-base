<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<style>
body {
	font-family: 'Pretendard', sans-serif;
	background-color: #f4f6f8;
	color: #333;
}

.container {
	margin-top: 30px;
	width: 1600px;
}

.card {
	margin-bottom: 30px;
	border: none;
	border-radius: 15px;
	box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
	overflow: hidden;
	width: 1600px;
}

.card-header {
	font-size: 1.3rem;
	font-weight: 600;
	background-color: #ffffff;
	padding: 20px;
	border-bottom: 1px solid #e0e0e0;
	width: 1600px;
}

.card-body {
	padding: 25px;
	background-color: #ffffff;
	width: 1600px;
}

.breadcrumb {
	background: none;
	padding: 0;
	margin: 0;
	font-size: 0.95rem;
}

.breadcrumb .breadcrumb-item+.breadcrumb-item::before {
	content: '>';
	color: #6c757d;
	margin: 0 5px;
}

.breadcrumb .breadcrumb-item a {
	color: #0d6efd;
	text-decoration: none;
}

.breadcrumb .breadcrumb-item.active {
	color: #6c757d;
}

.form-row {
	display: flex;
	flex-wrap: wrap;
	gap: 20px;
	align-items: flex-end;
}
	.filter-section {
		display: flex;
		flex-wrap: wrap;
		align-items: flex-end;
		justify-content: space-between;
		gap: 20px;
	}

	.filter-group {
		display: flex;
		flex-direction: column;
		align-items: center;
		min-width: 150px;
	}

	.filter-group label {
		font-weight: 600;
		margin-bottom: 6px;
		text-align: center;
	}

	.filter-group select,
	.filter-group input[type="date"] {
		width: 160px;
		text-align: center;
		border-radius: 6px;
		padding: 6px 10px;
	}

	.button-group {
		display: flex;
		gap: 10px;
	}

label {
	font-weight: 600;
	margin-bottom: 8px;
	display: inline-block;
}

select, input[type="date"] {
	width: 100%;
	padding: 10px 12px;
	border: 1px solid #ced4da;
	border-radius: 8px;
	background-color: #f9f9f9;
	transition: border-color 0.3s ease-in-out;
}

select:focus, input[type="date"]:focus {
	border-color: #0d6efd;
	outline: none;
	background-color: #ffffff;
}

.btn-group {
	display: flex;
	gap: 12px;
}

button.btn {
	padding: 10px 18px;
	font-weight: 500;
	border-radius: 8px;
	transition: all 0.2s ease-in-out;
}

button.btn:hover {
	transform: translateY(-1px);
}

.table th, .table td {
	vertical-align: middle;
	padding: 14px;
}

.table th {
	background-color: #f1f3f5;
	font-weight: bold;
	color: #495057;
}

.table td {
	background-color: #ffffff;
	white-space: nowrap;
}

.filter-section select {
	width: 200px;
}
.emp-link {
  display: inline-block;
  padding: 6px 14px;
  color: #0d6efd;
  border-radius: 6px;
  font-weight: 500;
  font-size: 17px;
  text-decoration: none;
  transition: background-color 0.25s ease, color 0.25s ease, box-shadow 0.25s ease;
}

.emp-link:hover {
  background-color: #dbeaff;
  color: #084298;
  box-shadow: 0 2px 6px rgba(0, 123, 255, 0.25);
}

.emp-link:active {
  background-color: #c7dbff;
  color: #052c65;
}

</style>
<h3>ì „ì‚¬ ê·¼íƒœí˜„í™©</h3>
<div class="page-container container-fluid" style="width: 1600px">
	<div
		class="d-flex justify-content-between align-items-center p-3 rounded-3 shadow-sm mb-4"
		style="background-color: #f8f9fa;">
		<!-- ì¢Œì¸¡: Breadcrumb -->
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb mb-0">
				<li class="breadcrumb-item fw-bold text-primary">ğŸ“Œ Quick Menu</li>
				<li class="breadcrumb-item active" aria-current="page">ì „ì‚¬ ê·¼íƒœí˜„í™©</li>
				<li class="breadcrumb-item"><a
					href="${pageContext.request.contextPath }/annualList">ì—°ì°¨ ë³´ìœ í˜„í™©</a></li>
			</ol>
		</nav>

		<!-- ìš°ì¸¡: ë²„íŠ¼ ê·¸ë£¹ -->
		<div>
			<button type="button" class="btn btn-outline-secondary"
				onclick="history.back();">
				<i class="fas fa-arrow-left"></i> ë’¤ë¡œê°€ê¸°
			</button>
		</div>
	</div>
</div>
<div class="container">
	<div class="card">
		<div class="card-body">
			<div id="chart-profile-visit"></div>
		</div>
	</div>
	<div class="card">
	<div class="card-body">
		<div class="filter-section">
			<div class="filter-group">
				<label for="department">ë¶€ì„œ</label>
				<select id="department" class="form-control">
					<option value="">ì „ì²´</option>
					<c:forEach items="${departmentList}" var="departmentVO">
						<option value="${departmentVO.departmentId}">
							${departmentVO.departmentName}
						</option>
					</c:forEach>
				</select>
			</div>

			<div class="filter-group">
				<label for="team">íŒ€</label>
				<select id="team" class="form-control">
					<option value="">ì „ì²´</option>
					<c:forEach items="${teamList}" var="teamVO">
						<option value="${teamVO.teamId}" data-departmentId="${teamVO.departmentId}">
							${teamVO.teamName}
						</option>
					</c:forEach>
				</select>
			</div>

			<div class="filter-group">
				<label for="date">ë‚ ì§œ ì„ íƒ</label>
				<input type="date" id="date" name="date" class="form-control">
			</div>

			<div class="button-group">
				<button class="btn btn-outline-success" onclick="downloadExcel()">Excel ë‹¤ìš´ë¡œë“œ</button>
				<button class="btn btn-outline-danger" onclick="exportPDF()">PDF ì¶œë ¥</button>
			</div>
		</div>
	</div>
</div>
	<div class="card">
		<div class="card-body">
			<div id="table-container"></div>
		</div>
	</div>
</div>

<script>
//PDF ë‹¤ìš´ë¡œë“œ
function exportPDF() {
	const element = document.querySelector("#table1");

	const opt = {
		margin: 1,
		filename: 'ì¶œí‡´í˜„í™©.pdf',
		html2canvas: { scale: 2 },
		jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
	};

	html2pdf().from(element).set(opt).save();
}

// Excel ë‹¤ìš´ë¡œë“œ
function downloadExcel() {
	var table = document.querySelector("#table1");
	var wb = XLSX.utils.table_to_book(table, { sheet: "ì¶œí‡´í˜„í™©" });
	XLSX.writeFile(wb, "ì¶œí‡´í˜„í™©.xlsx");
}
document.addEventListener("DOMContentLoaded", function() {
	fetchFilteredData();
	
	

	// í˜„ì¬ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì„¤ì •
	var today = new Date();
	var day = ("0" + today.getDate()).slice(-2);
	var month = ("0" + (today.getMonth() + 1)).slice(-2);
	var year = today.getFullYear();

	document.getElementById('date').value = year + "-" + month + "-" + day;

	var departmentList = [
		<c:forEach items="${departmentList}" var="x">
			{
				"departmentName": "${x.departmentName}",
			"departmentId": "${x.departmentId}",
			"employeeCount": "${x.departmentEmployeeCount}" // ë¶€ì„œë³„ ì¸ì›ìˆ˜
            } <c:if test="${not empty x}">,</c:if>
		</c:forEach>
	];

	var arr_dept = [
		<c:forEach items="${departmentList}" var="x">
			"${x.departmentName}",
		</c:forEach>
	];

	var departmentAliveCount = [
		<c:forEach items="${todayAlive}" var="x">
			{"departmentName" : "${x.departmentName}",
			"AliveemployeeCount": "${x.departmentArrivedEmployeeCount}" //ë¶€ì„œë³„ ì¶œê·¼í•œ ì¸ì›ìˆ˜
        } <c:if test="${not empty x}">,</c:if>
		</c:forEach>
	];

	var dac = departmentAliveCount; // ë‚ ì§œë³„ ê·¼íƒœê°€ ìˆëŠ” ë¶€ì„œì˜ ë¦¬ìŠ¤íŠ¸ì™€ ê·¼íƒœì°ì€ ì¸ì› ìˆ˜

	const AliveCount = [];
	dac.forEach(function(department) {
		AliveCount.push(department.AliveemployeeCount);
	});
	
	document.getElementById("department").addEventListener("change", filterTeams);
	 
	// ë¶€ì„œì— í•˜ìœ„ íŒ€ë§Œ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
	function filterTeams() {
		var selectedDept = document.getElementById("department").value;
		var teamSelect = document.getElementById("team");  // íŒ€ ì…€ë ‰íŠ¸ ë°•ìŠ¤
		var teamOptions = document.querySelectorAll(".team-option");

		// íŒ€ ì…€ë ‰íŠ¸ë¥¼ "ì „ì²´"ë¡œ ë¦¬ì…‹
		teamSelect.value = "";
		teamOptions.forEach(function(option) {
			if (selectedDept === "" || option.dataset.departmentid === selectedDept) {
				option.style.display = "block";
			} else {
				option.style.display = "none";
			}
		});

		fetchFilteredData(); // ë¶€ì„œê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ í•„í„°ë§ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
	}

	// íŒ€ ë³€ê²½ ì‹œ í•„í„°ë§ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
	$("#team").change(function() {
		fetchFilteredData(); // íŒ€ ì„ íƒ ì‹œ í•„í„°ë§ëœ ë°ì´í„° ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
	});

	// ë‚ ì§œ ë³€ê²½ ì‹œ í•„í„°ë§ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
	$("#date").change(function() {
		fetchFilteredData(); // ë‚ ì§œ ë³€ê²½ ì‹œ ë°ì´í„° ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
	});

	// í•„í„°ë§ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
	function fetchFilteredData() {
		var departmentId = $("#department").val();
		var teamId = $("#team").val();
		var date = $("#date").val();

		$.ajax({
			url: "/filter",
			type: "GET",
			data: {
				departmentId: departmentId,
				teamId: teamId,
				date: date
			},
			dataType: "json",
			success: function(data) {
				updateTable(data.attendanceList);
				updateChart(data);  // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì¶”ê°€
			},
			error: function() {
				alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
			}
		});
	}

	function updateTable(data) {
	    // ê¸°ì¡´ í…Œì´ë¸” ì œê±°
	    $("#table1").remove();

	    // ìƒˆ í…Œì´ë¸” ìƒì„±
	    var table = $("<table>").attr("id", "table1").addClass("table table-bordered");
	    var thead = $("<thead>").html(`
	        <tr>
	            <th>ë¶€ì„œ</th>
	            <th>íŒ€</th>
	            <th>ì´ë¦„</th>
	            <th>ì¶œê·¼</th>
	            <th>í‡´ê·¼</th>
	            <th>ê·¼ë¬´ì‹œê°„</th>
	            <th>ì—°ì¥ê·¼ë¬´</th>
	            <th>ì•¼ê°„ê·¼ë¬´</th>
	            <th>ìƒíƒœ</th>
	        </tr>
	    `);
	    var tbody = $("<tbody>");

	    if (data.length === 0) {
	        tbody.append("<tr><td class='text-center' colspan='9'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>");
	    } else {
	        $.each(data, function(index, x) {
	            var row = `
	                <tr>
	                    <td>\${x.employee.department.departmentName || "-"}</td>
	                    <td>\${x.employee.team.teamName || "-"}</td>
	                    <td><a class="emp-link" href="/myAttendance?empId=\${x.empId}">\${x.employee.name}</a> </td>
	                    <td>\${x.workStartTime || ""}</td>
	                    <td>\${x.workEndTime || ""}</td>
	                    <td>\${x.workingHours ? x.workingHours + "ì‹œê°„ " + (x.workingMinutes || 0) + "ë¶„" : ""}</td>
	                    <td>\${x.overtimeHours ? x.overtimeHours + "ì‹œê°„ " + (x.overtimeMinutes || 0) + "ë¶„" : ""}</td>
	                    <td>\${x.nightWorkHours ? x.nightWorkHours + "ì‹œê°„ " + (x.nightWorkMinutes || 0) + "ë¶„" : ""}</td>
	                    <td>\${x.attendanceStatus || ""}</td>
	                </tr>
	            `;
	            tbody.append(row);
	        });
	    }

	    table.append(thead).append(tbody);

	    // ì‚½ì… ìœ„ì¹˜ëŠ” í˜ì´ì§€ì— ë§ê²Œ ì¡°ì •
	    $("#table-container").html(table);  // ì˜ˆ: <div id="table-container"></div>ê°€ ìˆëŠ” ê²½ìš°
	    new simpleDatatables.DataTable(document.getElementById("table1"));
	}

	var barOptions = {
	  series: [
		{
		  name: "ì¶œê·¼",
		  data: AliveCount,
		},
	  ],
	  chart: {
		type: "bar",
		height: 350,
	  },
	  title: {
		    text: "ì˜¤ëŠ˜ì˜ ì¶œê·¼ í˜„í™©", // âœ… ì°¨íŠ¸ ì œëª© ì¶”ê°€
		    align: "center", // âœ… ì¤‘ì•™ ì •ë ¬
		    style: {
		      fontSize: "18px", // âœ… ê¸€ì í¬ê¸° ì„¤ì •
		      fontWeight: "bold", // âœ… êµµê²Œ í‘œì‹œ
		      color: "#333", // âœ… ê¸€ì ìƒ‰ìƒ ì„¤ì •
		    },
		  },
	  plotOptions: {
		bar: {
		  horizontal: false,
		  columnWidth: "55%",
		  endingShape: "rounded",
		},
	  },
	  dataLabels: {
		enabled: true,
	  },
	  stroke: {
		show: true,
		width: 2,
		colors: ["transparent"],
	  },
	  xaxis: {
	  categories: departmentList.map(function(department) {
	      return `\${department.departmentName}`;
	    }),
	    labels: {
	        rotate: 0, // 0ë„ë¡œ ì„¤ì •í•˜ë©´ ê¸€ìê°€ ë˜‘ë°”ë¡œ ì¶œë ¥ë¨
	        style: {
	            fontSize: '14px',       // ê¸€ì”¨ í¬ê¸°
	            fontFamily: 'Pretendard, sans-serif', // ì›í•˜ëŠ” ê¸€ê¼´ë¡œ ì„¤ì • (ê¸°ë³¸ í•œê¸€ ì¹œí™”ì )
	            fontWeight: 500,        // ê¸€ì”¨ ë‘ê»˜
	            colors: '#333'          // ê¸€ì”¨ ìƒ‰ìƒ (ì„ íƒì‚¬í•­)
	          }
	        }
	  },
	  yaxis: {
		  min: 0,
	    max: 30, // ì´ ì¸ì›ë³´ë‹¤ í° ìµœëŒ€ê°’ ì„¤ì •
	  },
	  fill: {
		opacity: 1,
	  },
	  tooltip: {
		y: {
		  formatter: function (val) {
			return val + "ëª…";
		  },
		},
	  },
	}

	// ApexCharts ì°¨íŠ¸ ìƒì„±
	var chartBar = new ApexCharts(
		document.querySelector("#chart-profile-visit"),
		barOptions
	);

	// ì°¨íŠ¸ ë Œë”ë§
	chartBar.render();

	// ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
	function updateChart(mylist) {

		let arr_cnt = [];
		for(var i=0;i<departmentList.length;i++){
			arr_cnt.push(0);
		}

		for(var i=0;i<mylist.attendanceList.length;i++){
			let departmentName = mylist.attendanceList[i].employee.department.departmentName;

			for(var j=0;j<arr_dept.length;j++){
				if(arr_dept[j]==departmentName){
					arr_cnt[j]++;
					break;
				}
			}
		}
		// ì¶œê·¼ ì¸ì› ë°ì´í„° ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì°¨íŠ¸ ìœ ì§€)
		chartBar.updateSeries([{
			name: "ì¶œê·¼",
			data: arr_cnt
		}]);

	}
});
</script>

<script
		src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
