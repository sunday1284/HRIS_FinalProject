<%@ page contentType="text/html;charset=UTF-8" language="java"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>

<head>
<title>ì¸ì‚¬í‰ê°€ í˜„í™©íŒ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<style>
.dashboard-card h5,
.dashboard-card h2 {
  color: #fff !important;
}
.dashboard-card {
	border-radius: 1rem;
	padding: 1.5rem;
	color: white;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.card-blue {
	background-color: #007bff;
}

.card-green {
	background-color: #28a745;
}

.card-red {
	background-color: #b44e58;
}

.card-orange {
	background-color: #fd7e14;
}

hr.border-dark {
	border: 1px solid #444;
	margin: 6px 0;
}

.table-group-header td {
	background-color: #f0f2f5;
	border-top: 2px solid #888;
	font-weight: bold;
}

.back-btn {
	margin-bottom: 20px;
}
.btn-link-group {
  margin-bottom: 20px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
</style>
</head>

<div class="page-container container-fluid">
	<div class="d-flex justify-content-between align-items-center mb-2">
		<!-- ì¢Œì¸¡: ë²„íŠ¼ ê·¸ë£¹ -->
		<div>
			<button type="button" class="btn btn-outline-secondary"
				onclick="history.back();">
				<i class="fas fa-arrow-left"></i>
			</button>
		</div>

		<!-- ìš°ì¸¡: Breadcrumb -->
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb mb-0">
				<li class="breadcrumb-item fw-bold text-primary"><a
					href="${pageContext.request.contextPath }/account/login/home">ğŸ“ŒMain</a></li>
				<li class="breadcrumb-item active" aria-current="page">ì¸ì‚¬í‰ê°€ í˜„í™©íŒ</li>
				<li class="breadcrumb-item"><a href="${pageContext.request.contextPath }/evaluation/evaluationCandidateList">í‰ê°€ ëŒ€ìƒì ë“±ë¡</a></li>
				<li class="breadcrumb-item"><a href="${pageContext.request.contextPath }/evaluation/evaluationTypeList">í‰ê°€ ê¸°ì¤€ ì„¤ì •</a></li>
			</ol>
		</nav>
	</div>
</div>
<br />

<body class="p-4">
	<h2 class="mb-4">
		ğŸ“Š ì¸ì‚¬í‰ê°€ í˜„í™©íŒ
		<c:choose>
			<c:when test="${empty evaluationYear}"></c:when>
			<c:otherwise> - ${evaluationYear}ë…„
        <c:choose>
					<c:when test="${halfYear == '1'}">ìƒë°˜ê¸°</c:when>
					<c:when test="${halfYear == '2'}">í•˜ë°˜ê¸°</c:when>
				</c:choose>
			</c:otherwise>
		</c:choose>
	</h2>
	
		<!-- ğŸ”— ë§í¬ ë²„íŠ¼ -->
	<div class="btn-link-group">
	  <a href="${pageContext.request.contextPath}/evaluation/evaluationCandidateList" class="btn btn-outline-primary">
	    <i class="bi-person-check"></i> í‰ê°€ ëŒ€ìƒì ë“±ë¡
	  </a>
	  <a href="${pageContext.request.contextPath}/evaluation/evaluationTypeList" class="btn btn-outline-primary">
	    <i class="bi-person-plus"></i> í‰ê°€ ê¸°ì¤€ ì„¤ì •
	  </a>
	  <a href="${pageContext.request.contextPath}/evaluation/evaluationDetail_Rank" class="btn btn-outline-success">
	    <i class="bi bi-check-circle-fill text-success"></i> í‰ê°€í•˜ê¸°
	  </a>
	</div>

	<form class="row g-3 mb-4" method="get"
		action="/evaluation/evaluationDashboard">
		<div class="col-md-2">
			<label class="form-label">í‰ê°€ ì—°ë„</label> <select name="evaluationYear"
				class="form-select">
				<c:forEach var="year" begin="2020" end="2025">
					<option value="${year}"
						<c:if test="${evaluationYear == year}">selected</c:if>>${year}</option>
				</c:forEach>
			</select>
		</div>
		<div class="col-md-2">
			<label class="form-label">ë°˜ê¸°</label> <select name="halfYear"
				class="form-select">
				<option value="1" <c:if test="${halfYear == '1'}">selected</c:if>>ìƒë°˜ê¸°</option>
				<option value="2" <c:if test="${halfYear == '2'}">selected</c:if>>í•˜ë°˜ê¸°</option>
			</select>
		</div>
		<div class="col-md-2 d-flex align-items-end">
			<button class="btn btn-primary w-100">ì¡°íšŒ</button>
		</div>
	</form>
		
	<!-- ìš”ì•½ ì¹´ë“œ -->
	<div class="row mb-4">
		<div class="col-md-3">
			<div class="dashboard-card card-blue text-center">
				<h5>ì „ì²´ í‰ê°€ ëŒ€ìƒì</h5>
				<h2>${summary.totalTarget}ëª…</h2>
			</div>
		</div>
		<div class="col-md-3">
			<div class="dashboard-card card-green text-center">
				<h5>í‰ê°€ ì™„ë£Œ</h5>
				<h2>${summary.completed}ëª…</h2>
			</div>
		</div>
		<div class="col-md-3">
			<div class="dashboard-card card-red text-center">
				<h5>í‰ê°€ ë¯¸ì™„ë£Œ</h5>
				<h2>${summary.notCompleted}ëª…</h2>
			</div>
		</div>
		<div class="col-md-3">
			<div class="dashboard-card card-orange text-center">
				<h5>í‰ê°€ ì§„í–‰ë¥ </h5>
				<h2>${summary.completionRate}%</h2>
			</div>
		</div>
	</div>

	<!-- ì°¨íŠ¸ -->
	<div class="card p-4 mb-4">
		<h5>í˜„í™©</h5>
		<canvas id="departmentChart" height="300"></canvas>
	</div>

	<!-- ë³¸ë¶€ë³„ í…Œì´ë¸” -->
	<div class="card p-4 mb-4">
		<h5 class="mb-3">ë³¸ë¶€ë³„</h5>
		<table class="table table-bordered text-center">
			<thead class="table-light">
				<tr class="table-primary fw-bold">
					<th>ë¶€ì„œ</th>
					<th>ëŒ€ìƒì ìˆ˜</th>
					<th>ì™„ë£Œ</th>
					<th>ë¯¸ì™„ë£Œ</th>
					<th>ì™„ë£Œìœ¨</th>
				</tr>
			</thead>
			<tbody>
				<c:forEach var="row" items="${departmentSummary}">
					<tr>
						<td>${row.departmentName}</td>
						<td>${row.targetCount}</td>
						<td>${row.completedCount}</td>
						<td>${row.notCompletedCount}</td>
						<td>${row.completionRate}%</td>
					</tr>
				</c:forEach>
			</tbody>
		</table>
	</div>

	<!-- íŒ€ë³„ í…Œì´ë¸” -->
	<div class="card p-4">
		<h5 class="mb-3">íŒ€ë³„</h5>
		<table class="table table-bordered text-center">
			<thead class="table-light">
				<tr class="table-primary fw-bold">
					<th>íŒ€</th>
					<th>ëŒ€ìƒì ìˆ˜</th>
					<th>ì™„ë£Œ</th>
					<th>ë¯¸ì™„ë£Œ</th>
					<th>ì™„ë£Œìœ¨</th>
					<th>ë¹„ê³ </th>
				</tr>
			</thead>
			<tbody>
				<c:set var="currentHQ" value="" />
				<c:forEach var="row" items="${dashboardList}">
					<c:if test="${currentHQ != row.departmentName}">
						<tr class="table-group-header">
							<td colspan="6" class="fw-bold">${row.departmentName}</td>
						</tr>
						<c:set var="currentHQ" value="${row.departmentName}" />
					</c:if>
					<tr>
						<td>${row.teamName}</td>
						<td>${row.targetCount}</td>
						<td>${row.completedCount}</td>
						<td>${row.notCompletedCount}</td>
						<td>${row.completionRate}%</td>
						<td>
<!-- 								ëª¨ë‹¬		 -->
<!-- 							<button class="btn btn-sm btn-outline-danger view-unsubmitted" -->
<%-- 						        data-year="${evaluationYear}"  --%>
<%-- 						        data-half="${halfYear}"  --%>
<%-- 						        data-teamid="${row.teamId}"> --%>
<!-- 						  		ë¯¸ì œì¶œ ëª…ë‹¨ ë³´ê¸° -->
<!-- 							</button> -->
<!-- 								í™”ë©´ì „í™˜		 -->
								<button class="btn btn-sm btn-outline-danger"
								onclick="location.href='/evaluation/unsubmittedModal?year=${evaluationYear}&half=${halfYear}&teamId=${row.teamId}'">
								ë¯¸ì œì¶œì ë³´ê¸°</button>

						</td>
					</tr>
				</c:forEach>
			</tbody>
		</table>
	</div>

	<!-- ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ -->
	<script>
		document.addEventListener("DOMContentLoaded", function () {
		  // âœ… ì°¨íŠ¸ ë Œë”ë§
		  try {
			let chartData = JSON.parse('<c:out value="${chartDataJson}" escapeXml="false" />');

			    // âœ… ë¶€ì„œëª…ì´ null, ë¹ˆ ë¬¸ìì—´ì¸ í•­ëª© ì œê±°
			    chartData = chartData.filter(item =>
			      item.DEPARTMENT_NAME && item.DEPARTMENT_NAME.trim() !== ""
			    );

			  
		    const labels = chartData.map(item => item.DEPARTMENT_NAME);
		    const completeData = chartData.map(item => item.COMPLETEDCOUNT);
		    const incompleteData = chartData.map(item => item.NOTCOMPLETEDCOUNT);

		    
		    
		    const ctx = document.getElementById('departmentChart').getContext('2d');
		    new Chart(ctx, {
		      type: 'bar',
		      data: {
		        labels: labels,
		        datasets: [
		          { label: 'ì™„ë£Œ', data: completeData, backgroundColor: '#28a745' },
		          { label: 'ë¯¸ì™„ë£Œ', data: incompleteData, backgroundColor: '#b44e58' }
		        ]
		      },
		      options: {
		        responsive: true,
		        plugins: {
		          title: { display: true, text: 'ì§„í–‰ë¥ ' },
		          legend: { position: 'top' }
		        },
		        scales: {
		          x: { stacked: true },
		          y: { stacked: true, beginAtZero: true }
		        }
		      }
		    });
		  } catch (e) {
		    console.error("ì°¨íŠ¸ ë Œë”ë§ ì‹¤íŒ¨:", e);
		  }

		// âœ… ë¯¸ì œì¶œì ëª¨ë‹¬ ë¡œë”©
		  document.querySelectorAll(".view-unsubmitted").forEach(button => {
		    button.addEventListener("click", function () {
		      const year = this.dataset.year;
		      const half = this.dataset.half;
		      const teamId = this.dataset.teamId;

		      fetch(`/evaluation/unsubmittedModalData?year=${year}&half=${half}&teamId=${teamId}`)
		        .then(res => res.json())
		        .then(data => {
		        	console.log("ğŸ“¦ ëª¨ë‹¬ ì‘ë‹µ:", data);
		            alert(`ë°ì´í„° ìˆ˜: ${data.length}`); // âœ… ë§ˆì§€ë§‰ ê²€ì¦ í¬ì¸íŠ¸

		          const tbody = document.getElementById("unsubmittedTableBody");
		          tbody.innerHTML = '';

		          if (data.length === 0) {
		            tbody.innerHTML = '<tr><td colspan="4">ë¯¸ì œì¶œìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
		          } else {
		            data.forEach(emp => {
		              const status = emp.evaluationStatus === 'Y' ? 'âœ… ì œì¶œì™„ë£Œ' : 'âŒ ë¯¸ì œì¶œ';
		              const row = `<tr>
		                <td>${emp.empId}</td>
		                <td>${emp.name}</td>
		                <td>${emp.teamName}</td>
		                <td>${status}</td>
		              </tr>`;
		              tbody.innerHTML += row;
		            });
		          }
		          new bootstrap.Modal(document.getElementById('unsubmittedModal')).show();

// 		          const modal = new bootstrap.Modal(document.getElementById('unsubmittedModal'));
// 		          modal.show();
		        })
		        .catch(err => {
		          alert("ë¯¸ì œì¶œì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
		          console.error("âŒ AJAX ì—ëŸ¬:", err);
		        });
		    });
		  });
		});
	</script>
</body>
