package kr.or.ddit.contract.controller;

import java.util.List;

import org.apache.ibatis.annotations.Param;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;

import kr.or.ddit.account.vo.AccountVO;
import kr.or.ddit.contract.service.Contractservice;
import kr.or.ddit.contract.vo.ContractVO;
import kr.or.ddit.security.SecurityUtil;
import kr.or.ddit.signature.service.SignatureService;
import kr.or.ddit.signature.vo.SignatureVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Controller
public class ContractController {
	@Autowired
	private Contractservice service;
	
	@Autowired
	private SignatureService Signservice;
	
	// ê·¼ë¡œê³„ì•½ì„œ ì¡°íšŒ(ì¸ì‚¬ë‹´ë‹¹ìë§Œ ì¡°íšŒ)
	@GetMapping("/contract/List")
	public String ContractList(Model model) {
		List<ContractVO> contractList = service.ContractList();
		model.addAttribute("contractList", contractList);
		return "tiles:contract/contractList";
		}
	// íŠ¹ì • ì‚¬ì›ì˜ ê·¼ë¡œê³„ì•½ì„œ ì¡°íšŒ(ì¸ì‚¬ë‹´ë‹¹ìë§Œ ì¡°íšŒ)
	@GetMapping("/contract/detail")
	public String ContractDetail(@RequestParam("empId")String empId, Model model) {
		ContractVO contract = service.selectContract(empId);
		model.addAttribute("contract", contract);
		return "tiles:contract/contractDetail";
	}
	// ê·¼ë¡œê³„ì•½ì„œ ë“±ë¡ í¼
    @GetMapping("/contract/registerForm")
    public String registerForm(Model model) {
    	List<ContractVO> unContractList =service.unContractList(); // ê·¼ë¡œê³„ì•½ì„œê°€ ì—†ëŠ” ì‚¬ì› ì¡°íšŒ
    	model.addAttribute("unContractList", unContractList);
    	model.addAttribute("contract", new ContractVO());
    	return "tiles:contract/contractRegister";
    }
    // ê·¼ë¡œê³„ì•½ì„œ ë“±ë¡
    @PostMapping("/contract/register")
    public String reister(ContractVO contract) {
    	service.insertContract(contract);
    	log.info("ê·¼ë¡œê³„ì•½ì„œ ë“±ë¡ ì™„ë£Œ ",contract);
    	return "redirect:/contract/List";
    }
    //ì§ì›ì˜ ì„œëª…ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    @PostMapping("/contract/sign")
    public String signContract(@RequestParam("contractId") int contractId, @RequestParam("empId") String empId) {
    	  AccountVO account = SecurityUtil.getrealUser();
          if (account == null || !account.getEmpId().equals(empId)) {
              log.warn("ì„œëª… ê¶Œí•œ ì—†ìŒ: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì™€ ê³„ì•½ì„œ ì‚¬ì›ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŒ.");
              return "redirect:/contract/myContract";
          }

          SignatureVO sign = Signservice.getSignature(empId);
          if (sign != null) {
              service.updateContractSign(contractId, sign.getSignId());
              log.info("ì„œëª… ì™„ë£Œ: ê³„ì•½ ID = {}, ì„œëª… ID = {}", contractId, sign.getSignId());
          } else {
              log.warn("ì„œëª… ì‹¤íŒ¨: ì„œëª… ì •ë³´ ì—†ìŒ empId = {}", empId);
          }
          return "redirect:/contract/myContract";
      }
    //ë‚´ ê·¼ë¡œê³„ì•½ì„œ ì¡°íšŒ
    @GetMapping("/contract/myContract")
    public String myContract(Model model) {
    	AccountVO account = SecurityUtil.getrealUser();

    	if (account != null) {
    	    String empId = account.getEmpId();
    	    System.out.println("ë‚˜ì™€ë¼ " + empId);
    	} else {
    	    System.out.println("ì‚¬ìš©ìê°€ ì—†ë‹¤");
    	}
    	String empId = account.getEmpId();
    	
    	log.info("empId123123123123123123123123", empId);
    	
    	ContractVO myContract = service.selectMyContract(empId);
    	if (myContract == null) {
    	    System.out.println("ê³„ì•½ì„œ ë°ì´í„° ì œë°œ ì¢€ ë‚˜ì™€ë¼ = " + empId);
    	} else {
    	    System.out.println("ğŸ“Œ ì¡°íšŒëœ ê³„ì•½ì„œ ë°ì´í„°: " + myContract);
    	}
    	 
    	log.info("myContractssssssssssss", myContract);
    	model.addAttribute("contract", myContract);
    	
    	return "tiles:contract/myContract";		
    }
    
}
