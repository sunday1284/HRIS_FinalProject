function connectWebSocket() {
	console.log("ğŸ”Œ WebSocket ì—°ê²° ì‹œë„...");

	let socket = new SockJS('/wss');
	stompClient = Stomp.over(socket);

	stompClient.connect({}, function (frame) {
		console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ: " + frame);

		stompClient.subscribe('/topic/onlineStatus', function (message) {
			console.log("ğŸ”„ ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ : ", message.body);
			loadEmployeeList();
		});
	}, function (error) {
		console.error("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨", error);
	});
}

function loadEmployeeList() {
	console.log("ğŸ“¥ ì§ì› ëª©ë¡ ìš”ì²­");

	$.ajax({
		url: "/messenger/empList",
		type: "GET",
		dataType: "json",
		success: function (data) {
			console.log("ğŸ“‹ ì§ì› ëª©ë¡ ìˆ˜ì‹  ì™„ë£Œ", data);

			const treeData = {};
			data.forEach(emp => {
				const dept = emp.department?.departmentName || "ë¯¸ì§€ì • ë¶€ì„œ";
				const team = emp.teamName || "ë¯¸ì§€ì • íŒ€";

				if (!treeData[dept]) treeData[dept] = {};
				if (!treeData[dept][team]) treeData[dept][team] = [];

				treeData[dept][team].push(emp);
			});

			let html = `
				<h3>ì§ì› ëª©ë¡</h3>
				<div style="margin-bottom: 10px;">
					<input type="text" id="empSearchInput" placeholder="ì´ë¦„, íŒ€, ë¶€ì„œ ê²€ìƒ‰" style="padding:5px; width:200px;">
					<button id="empSearchBtn">ê²€ìƒ‰</button>
					<button id="collapseAllBtn" style="margin-left:5px;">ì „ì²´ ë‹«ê¸°</button>
				</div>
				<div id="empListWrapper"><ul id="orgTree">
			`;

			for (const deptName in treeData) {
				html += `<li>
					<span class="toggle"><i class="fas fa-building" style="margin-right: 5px;"></i>${deptName}</span>
					<ul style="display: none;">`;

				for (const teamName in treeData[deptName]) {
					html += `<li>
						<span class="toggle"><i class="fas fa-users" style="margin-right: 5px;"></i>${teamName}</span>
						<ul style="display: none;">`;

					treeData[deptName][teamName].forEach(emp => {
						html += `
							<li class="employee-item"
								data-emp-id="${emp.empId}"
								data-name="${emp.empName}"
								data-dept="${deptName}"
								data-team="${teamName}">
								<i class="fas fa-user"></i> ${emp.empName} (${emp.rankName || 'N/A'})
								- ${emp.status === 'ì˜¨ë¼ì¸' ? 'ğŸŸ¢' : 'âšª'} ${emp.status}
							</li>`;
					});

					html += `</ul></li>`; // íŒ€ ë
				}
				html += `</ul></li>`; // ë¶€ì„œ ë
			}

			html += `</ul></div>`;
			$("#contentArea").html(html);

			// í† ê¸€ ê¸°ëŠ¥
			$(document).off("click", ".toggle").on("click", ".toggle", function () {
				const $toggle = $(this);
				const $ul = $toggle.next("ul");

				$toggle.toggleClass("open");
				if ($toggle.hasClass("open")) {
					$ul.stop(true, true).slideDown(300);
				} else {
					$ul.stop(true, true).slideUp(300);
				}
			});

			// ì§ì› í´ë¦­ ì‹œ ì±„íŒ…ë°© ì—´ê¸°
			$(".employee-item").on("click", function () {
				const empId = $(this).data("emp-id");
				openChatWith(empId);
			});

			// ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸
			$("#empSearchBtn").on("click", function () {
				const keyword = $("#empSearchInput").val().trim();
				if (keyword) searchAndExpandTree(keyword);
			});

			// ì—”í„° í‚¤ë¡œ ê²€ìƒ‰
			$("#empSearchInput").on("keypress", function (e) {
				if (e.which === 13) $("#empSearchBtn").click();
			});

			// ì „ì²´ ë‹«ê¸°
			$("#collapseAllBtn").on("click", function () {
				$(".toggle").removeClass("open");
				$("#orgTree ul").slideUp(300);
			});
		},
		error: function () {
			alert("âŒ ì§ì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
		}
	});
}

function searchAndExpandTree(keyword) {
	let found = false;

	$(".employee-item").each(function () {
		const $empItem = $(this);
		const name = $empItem.data("name");
		const dept = $empItem.data("dept");
		const team = $empItem.data("team");

		const isMatch = name.includes(keyword) || dept.includes(keyword) || team.includes(keyword);

		if (isMatch) {
			found = true;

			const teamLi = $empItem.closest("ul").closest("li");
			const teamToggle = teamLi.children(".toggle");
			const teamUl = teamToggle.next("ul");

			const deptLi = teamLi.closest("ul").closest("li");
			const deptToggle = deptLi.children(".toggle");
			const deptUl = deptToggle.next("ul");

			teamToggle.addClass("open");
			teamUl.stop(true, true).slideDown(300);

			deptToggle.addClass("open");
			deptUl.stop(true, true).slideDown(300);

			$(".employee-item").css("background", "");
			$empItem.css("background", "#ffff99");

			$empItem[0].scrollIntoView({ behavior: "smooth", block: "center" });
		}
	});

	if (!found) {
		alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
	}
}

function openChatWith(targetEmpId) {
	const currentEmpId = sessionStorage.getItem("currentUserId");
	if (!currentEmpId || !targetEmpId) {
		alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
		return;
	}

	$.ajax({
		url: "/messenger/selectOrInsertRoom",
		method: "POST",
		data: { empId1: currentEmpId, empId2: targetEmpId },
		success: function (roomId) {
			const popupName = `chatRoom_${roomId}`;
			const popupOptions = "width=600,height=500,left=300,top=100,resizable=yes,scrollbars=yes";
			window.open(`/messenger/room?roomId=${roomId}`, popupName, popupOptions);
		},
		error: function () {
			alert("âŒ ì±„íŒ…ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
		}
	});
}

$(document).ready(function () {
	console.log("ğŸ“¦ chatempList.js ë¡œë“œë¨");
	connectWebSocket();
	loadEmployeeList();

	$("#empListBtn").on("click", function (e) {
		e.preventDefault();
		console.log("ğŸ‘† ì§ì› ëª©ë¡ ë²„íŠ¼ í´ë¦­ë¨");
		loadEmployeeList();
	});
});
