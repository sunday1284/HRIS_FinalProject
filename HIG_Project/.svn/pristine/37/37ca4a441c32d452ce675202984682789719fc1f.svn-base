<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security"%>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
	#totalchart,#overtimechart,#remainchart {
	display: flex !important;
	justify-content: center !important;
	align-items: center !important;
	gap: 100px !important;
	width: 250px !important;
	height: 250px !important; /* ë†’ì´ ì¡°ì • */
	}

    body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f6f9;
    }

    .container {
        width: 100%;
        max-width: 1600px;
        margin: auto;
        padding: 30px;
        background: white;
        box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
    }

    h2 {
        text-align: center;
        font-weight: 700;
        margin-bottom: 30px;
        color: #333;
    }

    .summary {
        display: flex;
        justify-content: space-between;
    }

   .card {
    display: flex;              /* ë‚´ë¶€ ìš”ì†Œ ì •ë ¬ì„ ìœ„í•œ flex ì ìš© */
    justify-content: center;    /* ê°€ë¡œ ë°©í–¥ ì¤‘ì•™ ì •ë ¬ */
    align-items: center;        /* ì„¸ë¡œ ë°©í–¥ ì¤‘ì•™ ì •ë ¬ */
    color: black;
    padding: 20px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: bold;
    width: 30%;
    text-align: center;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
}

	.card canvas {
	    max-width: 100%;            /* ìº”ë²„ìŠ¤ í¬ê¸° ìë™ ì¡°ì ˆ */
	    max-height: 100%;           /* ìº”ë²„ìŠ¤ í¬ê¸° ìë™ ì¡°ì ˆ */
	    width: 200px !important;    /* ë„ë„› ì°¨íŠ¸ í¬ê¸° ì¡°ì • */
	    height: 200px !important;   /* ë„ë„› ì°¨íŠ¸ í¬ê¸° ì¡°ì • */
	}
    .card span {
        display: block;
        font-size: 22px;
    }

    .accordion {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 30px;
    }

    .week-left,
    .week-right {
        width: 48%;
        min-width: 400px; /* ì›í•˜ëŠ” ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
        overflow-x: auto; /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ê°€ë¡œ ìŠ¤í¬ë¡¤ì´ ìƒê¸°ë„ë¡ ì„¤ì • */
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    th,
    td {
        padding: 12px;
        border-bottom: 1px solid #ddd;
    }
    td {
        text-align: left;
        white-space: nowrap;
    }
     /* thëŠ” ì¤‘ì•™ ì •ë ¬ */
    th {
        background-color: #f1f1f1;
        text-align: center;
    }

    tr:hover {
        background-color: #f9f9f9;
    }

    .month-nav:hover{
    	 cursor: pointer;
    	 transform: scale(1.1);
    }
</style>
<div class="container">
<security:authentication property="principal" var="principal" />
<h5>
${employee.department.departmentName}
${employee.team.teamName}
${employee.name}
${employee.rank.rankName}
</h5>


		<input type="hidden" value="${employee.empId}" id="empId" />
	<h2>
		<span class="month-nav" onclick="changeMonth(-1)"> â«·</span>
		 <span id="currentMonth"></span>
		 <span class="month-nav" onclick="changeMonth(1)"> â«¸</span>
	</h2>
	<div class="summary">
		<div class="card">
			<input type="hidden" id="monthTotal"/>
 			 <canvas id="totalchart"></canvas>
		</div>
		<div class="card">
			<input type="hidden" id="monthOvertime"/>
			<canvas id="overtimechart"></canvas>
		</div>
		<div class="card">
			<input type="hidden" id="monthRemain"/>
			<canvas id="remainchart"></canvas>
		</div>
	</div>
</div>
<br>
<div class="container">
    <div class="accordion" id="weeksAccordion">
        <!-- ì™¼ìª½ í…Œì´ë¸” -->
        <div class="week-left" id="weekLeft">
            <table>
                <thead>
                    <tr>
                        <th>ì¼ì</th>
                        <th>ì—…ë¬´ ì‹œì‘</th>
                        <th>ì—…ë¬´ ì¢…ë£Œ</th>
                        <th>ì´ ê·¼ë¬´ ì‹œê°„</th>
                        <th>ê·¼ë¬´ ìƒì„¸</th>
                    </tr>
                </thead>
                <tbody></tbody> <!-- ë™ì ìœ¼ë¡œ ë‚ ì§œë³„ë¡œ ì¶”ê°€ë  ë¶€ë¶„ -->
            </table>
        </div>
        <!-- ì˜¤ë¥¸ìª½ í…Œì´ë¸” -->
        <div class="week-right" id="weekRight">
            <table>
                <thead>
                    <tr>
                        <th>ì¼ì</th>
                        <th>ì—…ë¬´ ì‹œì‘</th>
                        <th>ì—…ë¬´ ì¢…ë£Œ</th>
                        <th>ì´ ê·¼ë¬´ ì‹œê°„</th>
                        <th>ê·¼ë¬´ ìƒì„¸</th>
                    </tr>
                </thead>
                <tbody></tbody> <!-- ë™ì ìœ¼ë¡œ ë‚ ì§œë³„ë¡œ ì¶”ê°€ë  ë¶€ë¶„ -->
            </table>
        </div>
    </div>
</div>
<script>
//í˜„ì¬ ì›”ì„ ì„¤ì •í•©ë‹ˆë‹¤.
function updateMonth(monthOffset) {
	let today = new Date();
	let year = today.getFullYear();  // 2025
	let month = (today.getMonth() + 1).toString().padStart(2, '0'); //04

	console.log(year,month)
    let currentMonthText = document.getElementById('currentMonth').innerText;

    document.getElementById('currentMonth').innerText = `\${year}.\${month}`;
    generateTables(year, month);
    updateSummary(year, month);
}

// ì›” ë³€ê²½ ì´ë²¤íŠ¸
function changeMonth(offset) {

	let currentMonthText = document.getElementById('currentMonth').innerText;
	let currentDate = new Date(currentMonthText + "-01");  // 2025-03-01 (ì˜ˆì‹œ)

	currentDate.setMonth(currentDate.getMonth() + offset);  // í•œ ë‹¬ ì´ë™

	let year = currentDate.getFullYear();
	let month = (currentDate.getMonth() + 1).toString().padStart(2, '0');  // 0-based indexì´ë¯€ë¡œ +1 í•„ìš”
	document.getElementById('currentMonth').innerText = `\${year}.\${month}`;

	let ym = `\${year}-\${month}`;

	let empId = document.querySelector("#empId").value;
	console.log(empId);
	console.log(ym)
    $.ajax({
        url: '/myAttendance',
        type: 'GET',
        dataType:"json",
        data: { workDate:ym ,empId:empId },  //2025-2ì™€ empIdì „ë‹¬
        success: function(data) {
        	console.log(data.myAttendance)
            myAttendance = data.myAttendance;

            generateTables(year, month); // í…Œì´ë¸” ê°±ì‹ 
            updateSummary(year, month); // Summary ê°±ì‹ 
        },
        error: function(xhr, status, error) {
            console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
        }
    });
}


// ë‚ ì§œì— ë”°ë¼ í…Œì´ë¸” ìƒì„±
function generateTables(year, month) {
	accumulatedSecondsTotal = 0;

    let leftContainer = document.getElementById('weekLeft').querySelector('tbody');
    let rightContainer = document.getElementById('weekRight').querySelector('tbody');

    leftContainer.innerHTML = "";
    rightContainer.innerHTML = "";

    // í˜„ì¬ ì›”ì˜ ë°ì´í„°ë§Œ í•„í„°ë§
    let filteredData = myAttendance
    .filter(x => x.workDate.startsWith(`\${year}-\${month}`))
    .sort((a, b) => a.workDate.localeCompare(b.workDate)); // ë‚ ì§œìˆœ ì •ë ¬

    filteredData.forEach(x => {
        let day = parseInt(x.workDate.substring(8)); // ë‚ ì§œ ìˆ«ìë¡œ ë³€í™˜
        let tableRow = createTableRow(x);


        if (day <= 15) {
            leftContainer.innerHTML += tableRow; // 1~15ì¼ â†’ ì™¼ìª½
        } else {
            rightContainer.innerHTML += tableRow; // 16ì¼ ì´í›„ â†’ ì˜¤ë¥¸ìª½
        }
    });
        console.log("accumulatedSecondsTotal " + accumulatedSecondsTotal)
}

// ì´ˆë¥¼ ì‹œê°„/ë¶„/ì´ˆë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
function formatTime(seconds) {
    let h = Math.floor(seconds / 3600);
    let m = Math.floor((seconds % 3600) / 60);
    let s = seconds % 60;
    return `\${h}h \${m}m \${s}s`;
}

function updateSummary(year, month) {

	let totalSeconds = 0;
	//ì´ë²ˆ ë‹¬ì˜ í‰ì¼(ì›”~ê¸ˆ) ê°œìˆ˜ ê³„ì‚°
	let totalWeekdays = getWeekdaysInMonth(year, month);
	let targetWorkSeconds  = totalWeekdays * 8 * 3600; // í‰ì¼ * 8ì‹œê°„ * ì´ˆ ë‹¨ìœ„ ë³€í™˜

    // ê·¼ë¬´ ë°ì´í„° í•©ì‚°
    myAttendance.forEach(x => {
        if (x.workDate.startsWith(`\${year}-\${month}`)) {
            let totalMinutes = (parseInt(x.workingHours) || 0) * 60 + (parseInt(x.workingMinutes) || 0);
            totalSeconds += totalMinutes * 60; // ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜
        }
    });

    // ì´ë²ˆë‹¬ ì´ˆê³¼ ì‹œê°„ ê³„ì‚° (ëª©í‘œ ê·¼ë¬´ ì‹œê°„ì„ ì´ˆê³¼í•œ ë¶€ë¶„)
    let overtimeSeconds = Math.max(totalSeconds - targetWorkSeconds, 0);

    // ì´ë²ˆë‹¬ ì”ì—¬ ì‹œê°„ ê³„ì‚° (ëª©í‘œ ê·¼ë¬´ ì‹œê°„ì—ì„œ ì•„ì§ ë‚¨ì€ ì‹œê°„)
    let remainSeconds = Math.max(targetWorkSeconds - totalSeconds, 0);

    // DOM ì—…ë°ì´íŠ¸
    document.getElementById("monthTotal").innerText = formatTime(totalSeconds);
    document.getElementById("monthOvertime").innerText = formatTime(overtimeSeconds);
    document.getElementById("monthRemain").innerText = formatTime(remainSeconds);
    totalchart(totalSeconds,remainSeconds);
    overtimechart(overtimeSeconds);
    remainchart(remainSeconds);
}
//ê¸°ì¡´ ì°¨íŠ¸ ì €ì¥í•  ë³€ìˆ˜ ì„ ì–¸
let totalChartInstance = null;
let overtimeChartInstance = null;
let remainChartInstance = null;



function totalchart(totalSeconds, remainSeconds) {
    let ctx = document.getElementById('totalchart').getContext('2d');

    // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆë‹¤ë©´ ì‚­ì œ
    if (totalChartInstance) {
        totalChartInstance.destroy();
    }

    totalChartInstance = new Chart(ctx, {
    	  type: 'doughnut',
          data: {
              labels: ['ì´ë²ˆ ë‹¬ ê·¼ë¬´ ì‹œê°„'],
              datasets: [
                  {
                      data: [totalSeconds, remainSeconds],  // í˜„ì¬ ì‹œê°„ & ë‚¨ì€ ì‹œê°„
                      backgroundColor: ['#FF5733', '#EEEEEE'], // ê·¼ë¬´í•œ ì‹œê°„(ë¹¨ê°•), ë‚¨ì€ ì‹œê°„(íšŒìƒ‰)
                      hoverOffset: 4
                  }
              ]
          },
        options: {
            responsive: true,
            cutout: '80%',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let value = context.raw;
                            return `\${context.label}: \${formatTime(value)}`;
                        }
                    }
                }
            }
        },
        plugins: [{
            id: 'centerText',
            beforeDraw: function(chart) {
                let width = chart.width,
                    height = chart.height,
                    ctx = chart.ctx;

                ctx.restore();
                let fontSize = (height / 10).toFixed(2);  // í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì ˆ
                ctx.font = `\${fontSize}px sans-serif`;
                ctx.textBaseline = "middle";
                ctx.textAlign = "center";

                let text =  formatTime(totalSeconds);  // í‘œì‹œí•  í…ìŠ¤íŠ¸
                let textX = Math.round(width / 2);
                let textY = Math.round(height / 2.3);

                ctx.fillText(text, textX, textY);  // ì¤‘ì•™ì— í…ìŠ¤íŠ¸ ì¶”ê°€
                ctx.save();
            }
        }]
    });
}
function overtimechart(overtimeSeconds) {
    let ctx = document.getElementById('overtimechart').getContext('2d');

    if (overtimeChartInstance) {
        overtimeChartInstance.destroy();
    }
	console.log(overtimeSeconds)
   overtimeChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['ì´ˆê³¼ ê·¼ë¬´'],
            datasets: [
                {
                    data: [overtimeSeconds], // ì´ˆ ë‹¨ìœ„ ê·¸ëŒ€ë¡œ ì „ë‹¬!
                    backgroundColor: ['#EEEEEE'],
                    hoverOffset: 4,
                    weight: 0.5
                }
            ]
        },
        options: {
            responsive: true,
            cutout: '80%',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let dataset = context.dataset;
                            let value = dataset.data[context.dataIndex]; // ì´ˆ ë‹¨ìœ„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                            return `\${context.label}: \${formatTime(value)}`; // ë³€í™˜ëœ ì‹œê°„ í‘œì‹œ
                        }
                    }
                }
            }
        },
        plugins: [{
            id: 'centerText',
            beforeDraw: function(chart) {
                let width = chart.width,
                    height = chart.height,
                    ctx = chart.ctx;

                ctx.restore();
                let fontSize = (height / 10).toFixed(2);  // í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì ˆ
                ctx.font = `\${fontSize}px sans-serif`;
                ctx.textBaseline = "middle";
                ctx.textAlign = "center";

                let text =  formatTime(overtimeSeconds);  // í‘œì‹œí•  í…ìŠ¤íŠ¸
                let textX = Math.round(width / 2);
                let textY = Math.round(height / 2.3);

                ctx.fillText(text, textX, textY);  // ì¤‘ì•™ì— í…ìŠ¤íŠ¸ ì¶”ê°€
                ctx.save();
            }
        }]
    });
}
function remainchart(remainSeconds) {
    let ctx = document.getElementById('remainchart').getContext('2d');
    if (remainChartInstance) {
        remainChartInstance.destroy();
    }
	console.log(remainSeconds)
	remainChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['ë‚¨ì€ ê·¼ë¬´'],
            datasets: [
                {
                    data: [remainSeconds], // ì´ˆ ë‹¨ìœ„ ê·¸ëŒ€ë¡œ ì „ë‹¬!
                    backgroundColor: ['#FFD700'],
                    hoverOffset: 4,
                    weight: 0.5
                }
            ]
        },
        options: {
            responsive: true,
            cutout: '80%',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let dataset = context.dataset;
                            let value = dataset.data[context.dataIndex]; // ì´ˆ ë‹¨ìœ„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                            return `\${context.label}: \${formatTime(value)}`; // ë³€í™˜ëœ ì‹œê°„ í‘œì‹œ
                        }
                    }
                }
            }
        },
        plugins: [{
            id: 'centerText',
            beforeDraw: function(chart) {
                let width = chart.width,
                    height = chart.height,
                    ctx = chart.ctx;

                ctx.restore();
                let fontSize = (height / 10).toFixed(2);  // í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì ˆ
                ctx.font = `\${fontSize}px sans-serif`;
                ctx.textBaseline = "middle";
                ctx.textAlign = "center";

                let text =  formatTime(remainSeconds);  // í‘œì‹œí•  í…ìŠ¤íŠ¸
                let textX = Math.round(width / 2);
                let textY = Math.round(height / 2.3);

                ctx.fillText(text, textX, textY);  // ì¤‘ì•™ì— í…ìŠ¤íŠ¸ ì¶”ê°€
                ctx.save();
            }
        }]
    });
}
// ğŸ“Œ ì´ë²ˆ ë‹¬ í‰ì¼ ê°œìˆ˜ ê³„ì‚° í•¨ìˆ˜
function getWeekdaysInMonth(year, month) {
    let count = 0;
    let daysInMonth = new Date(year, month, 0).getDate(); // í•´ë‹¹ ì›”ì˜ ì´ ì¼ìˆ˜

    for (let day = 1; day <= daysInMonth; day++) {
        let date = new Date(year, month - 1, day); // JSì—ì„œ monthëŠ” 0ë¶€í„° ì‹œì‘
        let dayOfWeek = date.getDay(); // 0(ì¼ìš”ì¼) ~ 6(í† ìš”ì¼)

        if (dayOfWeek >= 1 && dayOfWeek <= 5) { // ì›”~ê¸ˆ (1~5)
            count++;
        }
    }
    return count;
}

// ê° ë‚ ì§œì— ëŒ€í•´ í…Œì´ë¸” í–‰ ìƒì„±
var myAttendance = [];

<c:forEach items="${myAttendance}" var="x">
myAttendance.push({
    workDate: "${x.workDate}",
    workStartTime: "${x.workStartTime}",
    workEndTime: "${x.workEndTime}",
    workingHours: "${x.workingHours}",
    workingMinutes: "${x.workingMinutes}",
    overtimeHours: "${x.overtimeHours}",
    overtimeMinutes: "${x.overtimeMinutes}",
    nightWorkHours: "${x.nightWorkHours}",
    nightWorkMinutes: "${x.nightWorkMinutes}"
});
</c:forEach>;


function createTableRow(x) {
	let workStartTime = x.workStartTime ? x.workStartTime.substring(0, 5) : 'N/A';  // 'N/A'ëŠ” ê¸°ë³¸ê°’
    let workEndTime = x.workEndTime ? x.workEndTime.substring(0, 5) : 'N/A';  // 'N/A'ëŠ” ê¸°ë³¸ê°’
    let workDate = x.workDate ? x.workDate.substring(8) : 'N/A';  // 'N/A'ëŠ” ê¸°ë³¸ê°’
    let workingHours = x.workingHours || '0';
    let workingMinutes = x.workingMinutes || '0';
    let overtimeHours = x.overtimeHours || '0';
    let overtimeMinutes = x.overtimeMinutes || '0';
    let nightWorkHours = x.nightWorkHours || '0';
    let nightWorkMinutes = x.nightWorkMinutes || '0';

    //ìˆ«ì ë³€í™˜
	let NumworkingHours = parseInt(x.workingHours) || 0;
	let NumovertimeHours = parseInt(x.overtimeHours) || 0;
	let NumnightWorkHours = parseInt(x.nightWorkHours) || 0;
	let NumworkingMinutes = parseInt(x.workingMinutes) || 0;
	let NumovertimeMinutes = parseInt(x.overtimeMinutes) || 0;
	let NumnightWorkMinutes = parseInt(x.nightWorkMinutes) || 0;

    // ğŸ”¹ ì´ ê·¼ë¬´ì‹œê°„ ê³„ì‚° (ê¸°ë³¸ + ì—°ì¥ + ì•¼ê°„)
    let totalMinutes = (NumworkingHours + NumovertimeHours + NumnightWorkHours) * 60 + (NumworkingMinutes + NumovertimeMinutes + NumnightWorkMinutes);

    let accumulatedSeconds = totalMinutes * 60;  // ë¶„ì„ ì´ˆë¡œ ë³€í™˜
    accumulatedSecondsTotal += accumulatedSeconds;

    let totalHours = Math.floor(totalMinutes / 60);
    let totalResultinutes = totalMinutes % 60;

    return `
	    <tr>
	        <td>\${workDate} </td>
	        <td>\${workStartTime}</td>
	        <td>\${workEndTime}</td>
	        <td>\${totalHours}ì‹œê°„ \${totalResultinutes}ë¶„</td>
	        <td>ê¸°ë³¸ \${workingHours}ì‹œê°„ \${workingMinutes}ë¶„ / ì—°ì¥ \${overtimeHours}ì‹œê°„ \${overtimeMinutes}ë¶„ / ì•¼ê°„ \${nightWorkHours}ì‹œê°„ \${nightWorkMinutes}ë¶„</td>
	    </tr>
	`;
}

// ì´ˆê¸° í˜ì´ì§€ ë¡œë“œ ì‹œ ì›” ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    updateMonth(0);  // í˜„ì¬ ì›”ë¡œ ì´ˆê¸°í™”
});


</script>
