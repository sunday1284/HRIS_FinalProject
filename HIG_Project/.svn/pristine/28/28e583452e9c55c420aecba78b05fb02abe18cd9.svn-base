let stompClient;
const senderId = sessionStorage.getItem("currentUserId"); // í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € ID

function connectChatRoom() {
  const socket = new SockJS("/wss");
  stompClient = Stomp.over(socket);

  stompClient.connect({}, function (frame) {
    console.log("ğŸŸ¢ ì±„íŒ…ë°© ì—°ê²°ë¨:", frame);

    stompClient.subscribe(`/topic/chat/${roomId}`, function (message) {
      const chat = JSON.parse(message.body);
      console.log("ë°›ì€ ë©”ì‹œì§€:", chat);
      showMessage(chat, true);
    });
  });
}

function sendMessage() {
  const content = $("#chatInput").val();
  if (!content || !senderId) return;

  const msg = {
    roomId,
    senderId,
    messageText: content
  };

  stompClient.send("/app/chat.send", {}, JSON.stringify(msg));
  $("#chatInput").val("");
}

function showMessage(chat, notify = false) {
  const isMine = chat.senderId === senderId;
  const openRoomId = sessionStorage.getItem("openRoomId");

  // ì•Œë¦¼
  if (notify && !isMine && Notification.permission === "granted") {
    if (String(chat.roomId) !== openRoomId) {
      new Notification(`${chat.senderName}ë‹˜`, {
        body: chat.messageText,
        icon: "https://cdn-icons-png.flaticon.com/512/3588/3588530.png"
      });
    }
  }

  const sentTime = chat.sentAt
    ? new Date(chat.sentAt).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
    : "";

  let messageBody = "";

  if (chat.chatFile && chat.fileDetail) {
    const file = chat.fileDetail;
    const downloadUrl = `/messenger/downloadFile?fileId=${file.detailId}`;
    const sizeText = file.fileSize < 1024 * 1024
      ? (file.fileSize / 1024).toFixed(1) + " KB"
      : (file.fileSize / (1024 * 1024)).toFixed(1) + " MB";

    messageBody = `
      <div class="file-card">
        <div class="file-icon">ğŸ“„</div>
        <div class="file-info">
          <div class="file-name">${file.fileName}</div>
          <div class="file-size">${sizeText}</div>
        </div>
        <a href="${downloadUrl}" class="file-download" target="_blank">ë‹¤ìš´ë¡œë“œ</a>
      </div>
    `;
  } else {
    messageBody = `<strong>${chat.senderName}</strong>: ${chat.messageText}`;
  }

  const messageHtml = `
    <div class="chat-message ${isMine ? 'mine' : 'other'}">
      <div class="chat-bubble">
        ${messageBody}
        <div class="chat-time">${sentTime}</div>
      </div>
    </div>
  `;

  $("#chat-box").append(messageHtml).scrollTop($("#chat-box")[0].scrollHeight);

  if (!isMine) {
    readMessage(chat.messageId, senderId);
  }
}

function loadPreviousMessages() {
  $.ajax({
    url: "/messenger/messages",
    type: "GET",
    data: { roomId: Number(roomId) },
    success: function (messages) {
      messages.forEach(msg => showMessage(msg, false));
    },
    error: function () {
      alert("ì´ì „ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  });
}

function readMessage(messageId, empId) {
  $.ajax({
    url: "/messenger/message/read",
    type: "POST",
    data: { messageId, empId }
  });
}

function requestNotificationPermission() {
  if (!("Notification" in window)) {
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.");
    return;
  }

  if (Notification.permission === "default") {
    Notification.requestPermission().then(permission => {
      if (permission === "granted") {
        console.log("ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨");
      }
    });
  }
}

function uploadFileOnly() {
  const fileInput = document.querySelector("#fileInput");
  const file = fileInput.files[0];

  if (!file) {
    alert("ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”");
    return;
  }

  uploadFile(file);
  fileInput.value = "";
}

function uploadFile(file) {
  const formData = new FormData();
  formData.append("file", file);
  formData.append("roomId", roomId);
  formData.append("senderId", senderId);

  fetch("/messenger/uploadFile", {
    method: "POST",
    body: formData
  })
    .then(resp => {
      if (!resp.ok) throw new Error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");
      return resp.text();
    })
    .then(() => {
      console.log("ë“œë¡­ ì—…ë¡œë“œ ì„±ê³µ");
    })
    .catch(err => {
      console.error("ë“œë¡­ ì—…ë¡œë“œ ì—ëŸ¬:", err);
    });
}

function loadMessagesAfterUpload() {
  $.ajax({
    url: "/messenger/messages",
    type: "GET",
    data: { roomId: Number(roomId) },
    success: function (messages) {
      const latest = messages[messages.length - 1];
      if (latest) showMessage(latest, true);
    }
  });
}

$(document).ready(function () {
  sessionStorage.setItem("openRoomId", String(roomId));

  requestNotificationPermission();
  connectChatRoom();
  loadPreviousMessages();

  $("#sendBtn").on("click", sendMessage);
  $("#chatInput").on("keypress", e => { if (e.which === 13) sendMessage(); });
  $("#uploadFileBtn").on("click", uploadFileOnly);
  $("#closeBtn").on("click", () => {
    sessionStorage.removeItem("openRoomId");
    window.close();
  });

  // ì°½ ë‹«ê¸° ì´ë²¤íŠ¸
  window.addEventListener("beforeunload", () => {
    sessionStorage.removeItem("openRoomId");
  });

  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì²˜ë¦¬
  const dropZone = document.getElementById("dropZone");

  if (dropZone) {
    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.classList.add("dragover");
    });

    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("dragover");
    });

    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("dragover");

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        uploadFile(files[0]);
      }
    });
  }
});
