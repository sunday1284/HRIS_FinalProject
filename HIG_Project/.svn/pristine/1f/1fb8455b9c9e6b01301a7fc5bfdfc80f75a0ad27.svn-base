<%@page import="java.util.HashMap"%>
<%@page import="java.time.LocalDate"%>
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>


<style>
.salary-summary-box {
  background: #fff;
  padding: 0.1rem;
  border-radius: 0.75rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  text-align: center;
  min-height: 110px; /* ë†’ì´ í†µì¼ */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center; /* â† ì¢Œìš° ì¤‘ì•™ */
}

.salary-summary-box h6 {
  color: #6c757d;
}

.salary-summary-box .fs-5 {
  margin-bottom: 0.5rem;
}

.chart-container {
  display: flex;
  flex-wrap: wrap;
  gap: 30px;
  margin-bottom: 40px;
}

.chart-box {
  flex: 1 1 45%;
  background: #fff;
  border-radius: 0.75rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  padding: 1.5rem;
}

canvas {
  width: 100% !important;
  height: 280px !important;
}

/* í…Œì´ë¸” ì…€ ì •ë ¬ */
#salaryList th,
#salaryList td,
#table1 th,
#table1 td {
  text-align: center !important;
}

/* í…Œì´ë¸” í—¤ë” ì „ìš© ê°€ìš´ë° ì •ë ¬ */
#table1 thead th {
  text-align: center !important;
  vertical-align: middle;
}

/* ê³ ì • ë„ˆë¹„ ìŠ¤íƒ€ì¼ */
.min-w-25 {
  min-width: 160px;
}

/* ì¹´ë“œ ë†’ì´ ë™ì¼í•˜ê²Œ */
.equal-height-card {
  min-height: 160px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

/* í…ŒìŠ¤íŠ¸ ì¶”ê°€ */
  html {
    scroll-behavior: smooth;
  }

  .nav-link {
    color: #495057;
    font-weight: 500;
  }

  .nav-link:hover, .nav-link.active {
    color: #0d6efd;
    border-bottom: 2px solid #0d6efd;
  }
</style>


<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item active" aria-current="page">ì‚¬ì›ê¸‰ì—¬ê´€ë¦¬</li>
    <li class="breadcrumb-item"><a href="/salary/transfer/list">ê¸‰ì—¬ì´ì²´í˜„í™©</a></li>
    <li class="breadcrumb-item"><a href="/Allowance/list">ìˆ˜ë‹¹/ê³µì œê´€ë¦¬</a></li>
    <li class="breadcrumb-item"><a href="#">ê¸‰ì—¬ê¸°ì¤€</a></li>
  </ol>
</nav>

<nav class="nav nav-pills flex-row mb-4 border-bottom pb-2">
  <a class="nav-link" href="#summarySection">ğŸ“Œ -</a>
  <a class="nav-link" href="#chartSection">ğŸ“Š -</a>
  <a class="nav-link" href="#salaryRegisterSection">ğŸ“‹ ê¸‰ì—¬ë“±ë¡</a>
</nav>


<!-- <div class="d-flex justify-content-between align-items-center mb-4"> -->
<!--    <h2 class="fw-bold">ì‚¬ì›ê¸‰ì—¬ê´€ë¦¬</h2> -->

<!--    <div class="d-flex align-items-center gap-3"> -->
<!--       <!-- ê¸‰ì—¬ ë“±ë¡ ê·¸ë£¹ -->
<!--       <div class="d-flex align-items-center gap-2"> -->
<!--          <!-- ë‹¨ê±´ ë“±ë¡ -->
<!--          <button type="button" class="btn btn-outline-secondary" onclick="location.href='/salary/form'">ê¸‰ì—¬ ë‹¨ê±´ ë“±ë¡</button> -->

<!--          <!-- ì¼ê´„ ë“±ë¡ -->
<!--          <form action="/salary/insert/register" method="post" class="d-flex align-items-center gap-2 mb-0"> -->
<%--             <input type="number" name="payYear" class="form-control" value="<%= LocalDate.now().getYear() %>" style="width: 100px;" required> --%>
<%--             <input type="number" name="payMonth" class="form-control" value="<%= LocalDate.now().getMonthValue() %>" style="width: 80px;" required> --%>
<!--             <button type="submit" class="btn btn-outline-primary">ğŸ’¾ ì¼ê´„ ë“±ë¡</button> -->
<!--          </form> -->
<!--       </div> -->

<!--       <!-- êµ¬ë¶„ì„  -->
<!--       <div class="vr mx-2" style="height: 40px;"></div> -->

<!--       <!-- ì¡°íšŒ ê·¸ë£¹ -->
<!--       <div class="d-flex align-items-center gap-2"> -->
<!--          <input type="month" id="payDate" class="form-control" style="width:auto;" /> -->
<!--          <button type="button" class="btn btn-primary" onclick="SalarySummary()">ğŸ” ì¡°íšŒ</button> -->
<!--       </div> -->
<!--    </div> -->
<!-- </div> -->

<div class="d-flex justify-content-between align-items-center mb-4">
   <h2 class="fw-bold">ì‚¬ì›ê¸‰ì—¬ê´€ë¦¬</h2>

   <div class="d-flex align-items-center gap-3">
      <!-- ì¡°íšŒ ê·¸ë£¹ -->
      <div class="d-flex align-items-center gap-2">
         <input type="month" id="payDate" class="form-control" style="width:auto;" />
         <button type="button" class="btn btn-primary" onclick="SalarySummary()">ğŸ“… ì¡°íšŒ</button>
      </div>

      <!-- ë“±ë¡/ë°œì†¡ ê·¸ë£¹ -->
      <div class="d-flex align-items-center gap-2">
         <!-- ë‹¨ê±´ ë“±ë¡ -->
         <button type="button" class="btn btn-outline-secondary" onclick="location.href='/salary/form'">ğŸ“„ ë‹¨ê±´ ë“±ë¡</button>

         <!-- ì¼ê´„ ë“±ë¡ -->
         <form action="/salary/insert/register" method="post" class="d-flex align-items-center gap-2 mb-0">
            <input type="number" name="payYear" class="form-control" value="<%= LocalDate.now().getYear() %>" style="width: 100px;" required>
            <input type="number" name="payMonth" class="form-control" value="<%= LocalDate.now().getMonthValue() %>" style="width: 80px;" required>
            <button type="submit" class="btn btn-outline-primary">ğŸ“‚ ì¼ê´„ ë“±ë¡</button>
         </form>

         <!-- ì¼ê´„ ë°œì†¡ -->
         <button type="button" class="btn btn-outline-danger" onclick="sendPayEmail()">ğŸ“§ ê¸‰ì—¬ëª…ì„¸ì„œ ì¼ê´„ ë°œì†¡</button>
      </div>
   </div>
</div>


<div class="row g-3 mb-4">
<!--    <div class="col"> -->
<!--       <div class="bg-white p-3 rounded-3 shadow-sm text-center"> -->
<!--          <h6 class="text-muted">ê·€ì†ë…„ì›”</h6> -->
<!--          <div class="fs-5 fw-bold text-primary" id="selectedDate"></div> -->
<!--       </div> -->
<!--    </div> -->

   <div class="col">
     <div class="salary-summary-box">
       <h6>ê·€ì†ë…„ì›”</h6>
       <div class="fs-5 fw-bold text-primary" id="selectedDate"></div>
     </div>
   </div>

   <div class="col">
      <div class="salary-summary-box">
         <h6 class="text-muted">ì „ì²´ ì§ì›ìˆ˜</h6>
         <div class="fs-5 fw-bold text-primary" id="totalemp"></div>
      </div>
   </div>

   <div class="col">
      <div class="salary-summary-box">
         <h6 class="text-muted">ê¸‰ì—¬ ë“±ë¡</h6>
         <div class="fs-5 fw-bold text-success" id="totalSalaryCount"></div>
      </div>
   </div>

   <div class="col">
      <div class="salary-summary-box">
         <h6 class="text-muted">ê¸‰ì—¬í™•ì •</h6>
         <div class="fs-5 fw-bold text-danger" id="confirmCount"></div>
             <button type="button" id="allFinal" onclick="allSuccess(this)" class="btn btn-sm btn-outline-primary">ì¼ê´„í™•ì •</button>
      </div>
   </div>

   <div class="col">
      <div class="salary-summary-box">
         <h6 class="text-muted">ìŠ¹ì¸ëŒ€ê¸°</h6>
         <div class="fs-5 fw-bold text-danger" id="reqPayCount"></div>
         <button type="button" id="allRequest" onclick ="requestAll(this)" class="btn btn-sm btn-outline-primary">ìŠ¹ì¸</button>
      </div>
   </div>

   <div class="col">
      <div class="salary-summary-box">
         <h6 class="text-muted">ì§€ê¸‰ì™„ë£Œ</h6>
         <div class="fs-5 fw-bold text-danger" id=""></div>
<!--             <button type="button" id="" class="btn btn-sm btn-outline-primary">ìŠ¹ì¸</button> -->
      </div>
   </div>
   <div class="col">
      <div class="salary-summary-box">
         <h6 class="text-muted">ì´ì§€ê¸‰ì•¡</h6>
         <div class="fs-5 fw-bold text-danger" id="totalNetSalary"></div>
      </div>
   </div>
</div>

<div class="chart-container">
   <div class="chart-box">
      <h5 class="fw-bold mb-3">ğŸ“Š ë¶€ì„œë³„ í‰ê·  ê¸‰ì—¬</h5>
      <canvas id="deptChart"></canvas>
   </div>
   <div class="chart-box">
      <h5 class="fw-bold mb-3">ğŸ“Š ì§ê¸‰ë³„ ê¸‰ì—¬ ë¶„í¬</h5>
      <canvas id="rankChart"></canvas>
   </div>
</div>

<div class="bg-white p-4 rounded-3 shadow-sm mb-4">
   <div class="table-responsive">

  <table id="table1" class="table table-striped datatable">
   <thead class="table-light">
         <tr>
            <th>ê·€ì†ì—°ì›”</th> <%--1 --%>
            <th>ì‚¬ì›ë²ˆí˜¸</th> <%--2 --%>
            <th>ì‚¬ì›ëª…</th>   <%--3 --%>
            <th>ë¶€ì„œ</th>       <%--4 --%>
            <th>íŒ€</th>     <%--5 --%>
            <th>ì§ê¸‰</th>    <%--6 --%>
            <th>ê¸°ë³¸ê¸‰</th>   <%--7 --%>
            <th>ì´ìˆ˜ë‹¹ì•¡</th>  <%--8 --%>
            <th>ì§€ê¸‰ì´ì•¡</th>  <%--9 --%>
            <th>ê³µì œì´ì•¡</th>  <%--10 --%>
            <th>ì‹¤ì§€ê¸‰ì•¡</th>  <%--11 --%>
            <th style="width: 90px;">ê¸‰ì—¬ëª…ì„¸</th> <%--12 --%>
            <th style="width: 90px;">ê¸‰ì—¬í™•ì •</th> <%--13 --%>
            <th>ìŠ¹ì¸ìš”ì²­</th>    <%--14 --%>
            <th>ì§€ê¸‰ìƒíƒœ</th>  <%--15 --%>
         </tr>
      </thead>
   <tbody>
<!--             summary.jsë™ì ìœ¼ë¡œ ë°›ìŒ -->

      <c:if test="${not empty salaryList }">
         <c:forEach items="${salaryList }" var="salaryVO">
            <tr>
               <td>${salaryVO.payYear}ë…„ ${salaryVO.payMonth}ì›”</td> <%--1.ê·€ì†ë…„ì›”--%>
               <td data-salaryid="${salaryVO.salaryId}">${salaryVO.empId}</td>  <%--2.ì‚¬ì›ë²ˆí˜¸--%>

                  <td>${salaryVO.employee.name}</td>  <%--3.ì‚¬ì›ëª…--%>
                  <td>${salaryVO.employee.department.departmentName}</td>  <%--4.ë¶€ì„œ--%>
                  <td>${salaryVO.employee.team.teamName}</td>  <%--5.íŒ€--%>
                  <td>${salaryVO.employee.rank.rankName}</td>  <%--6. ì§ê¸‰--%>

               <td>${salaryVO.baseSalary}</td>  <%--7. ê¸°ë³¸ê¸‰--%>
               <td>${salaryVO.totalAllowance}</td>  <%--8.ì´ìˆ˜ë‹¹ì•¡--%>
               <td>${salaryVO.totalPay}</td>  <%--9.ì§€ê¸‰ì´ì•¡--%>
               <td>${salaryVO.totalDeduction}</td>  <%--10.ì´ê³µì¬ì•¡--%>
               <td>${salaryVO.netSalary}</td>  <%--11.ì‹¤ì§€ê¸‰ì•¡--%>

               <td>
                   <button type="button" class="btn btn-outline-primary btn-sm open-detail-modal"
                       data-empid="${salaryVO.empId}"
                       data-payyear="${salaryVO.payYear}"
                       data-paymonth="${salaryVO.payMonth}"
                       data-paystatus="${salaryVO.payStatus}">
                       ë³´ê¸°
                   </button>  <%--12.ê¸‰ì—¬ëª…ì„¸--%>
               </td>

<!--                ê¸‰ì—¬í™•ì •  -->
                  <td> <%--13.ê¸‰ì—¬í™•ì •--%>
                    <div class="d-flex flex-column align-items-center">
                      <button type="button"
                              class="btn ${salaryVO.payStatus eq 'í™•ì •' ? 'btn-danger' : 'btn btn-outline-primary btn-sm'} btn-sm"
                              onclick="salaryFinal(this)">
                        <c:out value="${salaryVO.payStatus != null ? salaryVO.payStatus : 'í™•ì •ëŒ€ê¸°'}" />
                      </button>

                      <c:if test="${not empty salaryVO.confirmDate}">
                        <small class="confirm-date text-muted mt-1">${salaryVO.confirmDate}</small>
                      </c:if>
                    </div>
                  </td>


<!--                ê¸‰ì—¬ì§€ê¸‰ìš”ì²­ -->
               <td>
               <div class="d-flex flex-column align-items-center">
                  <button type="button" class="btn ${salaryVO.paymentRequest eq 'ìš”ì²­ì™„ë£Œ' ? 'btn-danger' : 'btn btn-outline-primary btn-sm'} btn-sm" id="fix"
                  onclick="salaryRequest(this)">
                   <c:out value="${salaryVO.paymentRequest != null ? salaryVO.paymentRequest : 'ìš”ì²­ëŒ€ê¸°'}" />
                  </button>

                  <c:if test="${not empty salaryVO.transferRequestDate}">
                        <small class="request-date text-muted mt-1">${salaryVO.transferRequestDate}</small>
                   </c:if>
               </div>

               </td> <%--14.ìŠ¹ì¸ìš”ì²­--%>

<!--                ê¸‰ì—¬ì§€ê¸‰ ì—¬ë¶€ -->
               <td>
                  <button type="button" class="btn ${salaryVO.paid eq 'ì§€ê¸‰ì™„ë£Œ' ? 'btn-danger' : 'btn btn-outline-primary btn-sm'} btn-sm" id="fix"
                  onclick="salaryPaid(this)">
                     ${salaryVO.paid}
                  </button>
               </td>  <%--15.ì§€ê¸‰ìƒíƒœ--%>
            </tr>
         </c:forEach>
      </c:if>



      </tbody>
      <!-- Toast ì˜ì—­ -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastArea"></div>

    </table>
  </div>
</div>

<%
	int currentYear = LocalDate.now().getYear();
	int currentMonth = LocalDate.now().getMonthValue();
%>
    
	<div class="bg-white p-4 rounded-3 shadow-sm mb-5">
	  <div class="d-flex justify-content-between align-items-center mb-3">
	    <h2 class="fw-bold mb-0">ğŸ“‚ ê¸‰ì—¬ ë“±ë¡</h2>
	    <small class="text-muted">${currentYear}ë…„ ${currentMonth}ì›” ê¸°ì¤€</small>
	  </div>

<form id="salaryForm" action="/salary/insert/register" method="post" class="row g-2 align-items-end mb-4">
	<div class="col-auto">
		<label class="form-label">ë“±ë¡ì—°ë„</label>
		<input type="number" name="payYear" value="<%= currentYear  %>" required>
	</div>
	
	<div class="col-auto">
		<label class="form-label">ë“±ë¡ì›”</label>
		<input type="number" name="payMonth" value="<%= currentMonth %>" required>
	</div>
		
	<div class="col-auto d-flex align-items-end">
		<button type="submit" class="btn btn-primary">ê¸‰ì—¬ì¼ê´„ ë“±ë¡</button>
	</div>
</form>
<br>

<div class="bg-white p-4 rounded-3 shadow-sm mb-5" id="salaryRegisterSection">
    <h2 class="mb-4 fw-bold">ğŸ“‹ ì²˜ë¦¬ì™„ë£Œ ê¸‰ì—¬</h2>

    <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
            <thead class="table-light">
                <tr>
                    <th>ê·€ì†ì—°ì›”</th>
                    <th>ì„ì§ì›ìˆ˜</th>
                    <th>ì´ì§€ê¸‰ì•¡</th>
                    <th>ì´ìˆ˜ë‹¹ì•¡</th>
                    <th>ì´ê³µì œì•¡</th>
                    <th>ì‹¤ì§€ê¸‰ì•¡</th>
                </tr>
            </thead>
            <tbody>
                <c:forEach items="${salarySummary }" var="salaryVOs">
                    <tr>
                        <td>${salaryVOs.payYear }ë…„ ${salaryVOs.payMonth }ì›”</td>
                        <td>${salaryVOs.totalemp }</td>
                        <td><fmt:formatNumber value="${salaryVOs.totalPaySum }" pattern="#,###" /></td>
                        <td><fmt:formatNumber value="${salaryVOs.totalAllowanceSum }" pattern="#,###" /></td>
                        <td><fmt:formatNumber value="${salaryVOs.totalDeductionSum }" pattern="#,###" /></td>
                        <td class="fw-bold text-primary">
                            <fmt:formatNumber value="${salaryVOs.totalNetSalary }" pattern="#,###" />
                        </td>
                    </tr>			
                </c:forEach>
                <c:if test="${empty salarySummary}">
                    <tr>
                        <td colspan="6" class="text-center text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                </c:if>
            </tbody>
        </table>
    </div>
</div>


<!-- ëª¨ë‹¬ -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-success text-white">
                <h1 class="modal-title fs-5 text-center w-100" id="exampleModalLabel"></h1>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body bg-light-subtle">
                <div id="modal-content-container"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal">ì €ì¥</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>



<!-- ê¸‰ì—¬ í™•ì • í™•ì¸ ëª¨ë‹¬ -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="confirmModalLabel">ê¸‰ì—¬ í™•ì • í™•ì¸</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>ğŸ“Œ ë‹¤ìŒ ê¸‰ì—¬ë¥¼ í™•ì •í•©ë‹ˆë‹¤.</p>
        <ul class="list-group">
          <li class="list-group-item">í™•ì • ëŒ€ìƒ ì‚¬ì› ìˆ˜: <span id="modalEmpCount"></span>ëª…</li>
          <li class="list-group-item">ì´ ì‹¤ì§€ê¸‰ì•¡ í•©ê³„: <span id="modalTotalAmount"></span>ì›</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-primary" id="confirmAllFinal">í™•ì • ì§„í–‰</button>
      </div>
    </div>
  </div>
</div>






<script src="${pageContext.request.contextPath}/resources/js/salary/salaryList.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/salary/salaryFinalStatus.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/salary/salaryRequestStatus.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/salary/salarySummary.js"></script>
<script src="${pageContext.request.contextPath}/resources/js/salary/salarySendPaymentMail.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

