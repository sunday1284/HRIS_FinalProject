<%@ page contentType="text/html; charset=UTF-8" language="java" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>

<head>
    <meta charset="UTF-8">
    <style>

        body {
            font-family: Arial, sans-serif; /* ê¸°ë³¸ ê¸€ê¼´ ì„¤ì • */
            margin: 0; /* body ê¸°ë³¸ ì—¬ë°± ì œê±° */
            display: flex;
            justify-content: center; /* ì»¨í…ì¸ ë¥¼ í™”ë©´ ê°€ìš´ë° ì •ë ¬ */
            align-items: center;
            min-height: 100vh; /* í™”ë©´ ë†’ì´ë¥¼ ê°€ë“ ì±„ìš°ë„ë¡ ì„¤ì • */
        }

        .container {
            display: grid;
            grid-template-columns: 0.30fr 0.70fr; /* ì™¼ìª½ í¼ 35%, ì˜¤ë¥¸ìª½ ë¦¬ìŠ¤íŠ¸ 65% ë¹„ìœ¨ë¡œ ì„¤ì • */
            gap: 20px; /* ì»¬ëŸ¼ ê°„ê²© ì¡°ì • */
            width: 90vw; /* ë·°í¬íŠ¸ ë„ˆë¹„ì˜ 90% ì‚¬ìš© */
            max-width: 1600px; /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
            background: white;
            padding: 20px;
            border-radius: 8px; /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* ê·¸ë¦¼ì íš¨ê³¼ ì¶”ê°€ */
        }

        .form-section, .list-section {
            padding: 20px;
            border: 1px solid #ddd; /* í…Œë‘ë¦¬ ì„¤ì • */
            border-radius: 8px;
            background-color: #ffffff; /* ë°°ê²½ í°ìƒ‰ */
        }

        .form-section h2, .list-section h2 {
            text-align: center; /* ì œëª© ê°€ìš´ë° ì •ë ¬ */
        }

        .form-group {
            margin-bottom: 15px; /* ê° ì…ë ¥ ê·¸ë£¹ ê°„ ê°„ê²© ì„¤ì • */
        }

        .form-group label {
            display: block; /* ë¸”ë¡ ìš”ì†Œë¡œ ë³€ê²½í•˜ì—¬ ì¤„ë°”ê¿ˆ ì ìš© */
            font-weight: bold; /* ê¸€ì”¨ êµµê²Œ */
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%; /* ì…ë ¥ ìš”ì†Œ ë„ˆë¹„ 100% ì„¤ì • */
            padding: 8px; /* ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
            margin-top: 5px; /* ë¼ë²¨ê³¼ ì…ë ¥ ìš”ì†Œ ê°„ê²© */
            border: 1px solid #ccc; /* í…Œë‘ë¦¬ ìƒ‰ìƒ ì§€ì • */
            border-radius: 5px; /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ ì„¤ì • */
        }

        .form-group input[type="number"] {
            width: 80px; /* ìˆ«ì ì…ë ¥ í•„ë“œ ë„ˆë¹„ ì œí•œ */
        }

        .button-group {
            text-align: center; /* ë²„íŠ¼ ê°€ìš´ë° ì •ë ¬ */
            margin-top: 20px; /* ìœ„ìª½ ì—¬ë°± ì„¤ì • */
        }

        .button-group button {
            padding: 8px 15px; /* ë²„íŠ¼ ë‚´ë¶€ ì—¬ë°± ì„¤ì • */
            margin: 5px; /* ë²„íŠ¼ ê°„ ê°„ê²© ì¡°ì • */
            border: none; /* í…Œë‘ë¦¬ ì œê±° */
            border-radius: 5px; /* ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
            cursor: pointer; /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì»¤ì„œ ë³€ê²½ */
        }

        .save-btn { background-color: #007bff; color: white; } /* ì €ì¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .reset-btn { background-color: #dc3545; color: white; } /* ì´ˆê¸°í™” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */

        table {
            width: 100%; /* í…Œì´ë¸” ë„ˆë¹„ 100% ì„¤ì • */
            border-collapse: collapse; /* í…Œë‘ë¦¬ ê²¹ì¹¨ ì œê±° */
            margin-top: 15px; /* ìœ„ìª½ ì—¬ë°± ì„¤ì • */
        }

        th, td {
            border: 1px solid #ddd; /* í…Œë‘ë¦¬ ì„¤ì • */
            padding: 8px; /* ë‚´ë¶€ ì—¬ë°± ì„¤ì • */
            text-align: center; /* í…ìŠ¤íŠ¸ ê°€ìš´ë° ì •ë ¬ */
        }

         th {
            background-color: #a0a0a0; /* í—¤ë” ë°°ê²½ìƒ‰ ì„¤ì • */
            color: white; /* í—¤ë” ê¸€ììƒ‰ ì„¤ì • */
          }

        .delete-btn {
            background-color: #dc3545; /* ì‚­ì œ ë²„íŠ¼ ë°°ê²½ìƒ‰ ì„¤ì • */
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }

        h2{
            margin-bottom : 40px; /* h2 ì•„ë˜ ì—¬ë°± ì„¤ì • */
        }
        h5{
        	text-align: center;
        }
    </style>
<script>
	function navigateHalf(direction) {
	    let currentYear = parseInt('${evaluationYear}');
	    let currentHalf = parseInt('${halfYear}');
	    let newYear = currentYear;
	    let newHalf = currentHalf;
	
	    if (direction === -1) {
	        if (currentHalf === 1) {
	            newYear--;
	            newHalf = 2;
	        } else {
	            newHalf = 1;
	        }
	    } else if (direction === 1) {
	        if (currentHalf === 2) {
	            newYear++;
	            newHalf = 1;
	        } else {
	            newHalf = 2;
	        }
	    }
	
	    location.href = '/evaluation/evaluationTypeList?evaluationYear=' + newYear + '&halfYear=' + newHalf;
	}

	// ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
    // ì…ë ¥ê°’ ê²€ì¦ ë° ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
//     function addEvaluation() {
//         const id = document.getElementById("evaluaTypeId").value.trim();
//         const rank = document.getElementById("rankId").value.trim();
//         const name = document.getElementById("evaluaName").value.trim();
//         const type = document.getElementById("evaluaType").value.trim();
//         const criteria = document.getElementById("evaluaCriteria").value.trim();
//         const weight = document.getElementById("evaluaWeight").value.trim();
//         const comment = document.getElementById("evaluaComment").value.trim();

//         if (!name || !type || !criteria || !weight) {
//             alert("í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
//             return;
//         }

//         const table = document.getElementById("evaluationTableBody");
//         const newRow = table.insertRow();

//         newRow.innerHTML = `
//             <td>${id}</td>
//             <td>${rank}</td>
//             <td>${name}</td>
//             <td>${type}</td>
//             <td>${criteria}</td>
//             <td>${weight}%</td>
//             <td>${comment}</td>
//             <td><button class="delete-btn" onclick="deleteRow(this)">ì‚­ì œ</button></td>
//         `;

//         // ì…ë ¥ í¼ ì´ˆê¸°í™”
//         document.getElementById("evaluation-form").reset();
//     }

	// í–‰ ì‚­ì œ & DBì‚­ì œ
    function deleteRow(button) {
	    const row = button.closest("tr");
	    const evaluaTypeId = row.querySelector('input[name$=".evaluaTypeId"]').value;
	
	    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
	
	    fetch('/evaluation/evaluationTypeDelete', {
	        method: 'POST',
	        headers: { 'Content-Type': 'application/json' },
	        body: JSON.stringify({ evaluTypeId: evaluaTypeId })
	    })
	    .then(response => response.json())
	    .then(data => {
	        if (data.success) {
	            location.reload(); // ì‚­ì œ í›„ í˜„ì¬ ì¡°ê±´ ìœ ì§€
	        } else {
	            alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
	        }
	    })
	    .catch(error => {
	        console.error("ì‚­ì œ ì˜¤ë¥˜:", error);
	        alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ì¸í•´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
	    });
	}
	
    function checkTotalWeight() {
        let total = 0;
        document.querySelectorAll('#evaluationTableBody tr').forEach(row => {
            const weightCell = row.cells[7]?.innerText.replace('%', '').trim(); // 7ë²ˆì§¸ ì—´: ê°€ì¤‘ì¹˜
            if (!isNaN(weightCell)) total += Number(weightCell);
        });

        const newWeight = parseInt(document.getElementById("evaluaWeight").value) || 0;
        const finalWeight = total + newWeight;

        if (finalWeight > 100) {
            alert("ì´ ê°€ì¤‘ì¹˜ê°€ 100%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤! í˜„ì¬: " + finalWeight + "%");
            return false;
        }
        return true;
    }

</script>
</head>

<div class="page-container container-fluid">
	<div class="d-flex justify-content-between align-items-center mb-2">
		<!-- ì¢Œì¸¡: ë²„íŠ¼ ê·¸ë£¹ -->
		<div>
			<button type="button" class="btn btn-outline-secondary"
				onclick="history.back();">
				<i class="fas fa-arrow-left"></i>
			</button>
		</div>

		<!-- ìš°ì¸¡: Breadcrumb -->
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb mb-0">
				<li class="breadcrumb-item fw-bold text-primary"><a
					href="${pageContext.request.contextPath }/account/login/home">ğŸ“ŒMain</a></li>
				<li class="breadcrumb-item"><a href="${pageContext.request.contextPath }/evaluation/evaluationDashboard">ì¸ì‚¬í‰ê°€ í˜„í™©íŒ</a></li>
				<li class="breadcrumb-item active" aria-current="page">í‰ê°€ ê¸°ì¤€ ì„¤ì •</li>
				<li class="breadcrumb-item"><a href="${pageContext.request.contextPath }/evaluation/evaluationDetail_Rank">í‰ê°€í•˜ê¸°</a></li>
			</ol>
		</nav>
	</div>
</div>
<br/>


<body>
<h2>í‰ê°€ ê¸°ì¤€ ì„¤ì •</h2>
<p> ì§ê¸‰ë³„ë¡œ ì ìš©ì‹œí‚¬ í‰ê°€ ì •ë³´ ë° ê°€ì¤‘ì¹˜ë¥¼ ì•„ë˜ì— ì…ë ¥í•´ì£¼ì„¸ìš”.</p>

<div class="container">
    <!-- í‰ê°€ ê¸°ì¤€ ì…ë ¥ í¼ -->
    <div class="form-section">
    
    <form id="evaluation-form" 
    	  action="${pageContext.request.contextPath}/evaluation/evaluationTypeInsert" 
    	  method="post"
    	  onsubmit="return checkTotalWeight();">

	    <div class="form-group">
		    <label for="evaluationYear">í‰ê°€ ì—°ë„</label>
		    <input type="text" id="evaluationYear" name="evaluationYear" value="2025" required>
		</div>
		
		<div class="form-group">
		    <label for="halfYear">ë°˜ê¸°</label>
		    <select id="halfYear" name="halfYear" required>
		        <option value="">ì„ íƒ</option>
		        <option value="1" selected>ìƒë°˜ê¸°</option>
		        <option value="2">í•˜ë°˜ê¸°</option>
		    </select>
		</div>
	    
<!-- 		    <div class="form-group"> -->
<!-- 		        <label for="evaluaTypeId">ìˆœë²ˆ</label> -->
<!-- 		        <input type="number" id="evaluaTypeId" name="evaluaTypeId" required> -->
<!-- 		    </div> -->
		    <div class="form-group">
		        <label for="rankId">í‰ê°€ëŒ€ìƒ</label>
		        <select id="rankId" name="rankId" required>
			        <option value="" disabled selected>ì„ íƒí•˜ì„¸ìš”</option>
			        <option value="3000">ì‚¬ì›</option>
			        <option value="3010">ëŒ€ë¦¬</option>
			        <option value="3020">ê³¼ì¥</option>
			        <option value="3030">ì°¨ì¥</option>
			        <option value="3040">ë¶€ì¥</option>
			    </select>
		    </div>
		    <div class="form-group">
		        <label for="evaluaName">í‰ê°€ëª…</label>
		        <input type="text" id="evaluaName" name="evaluaName" required>
		    </div>

		    <div class="form-group">
		        <label for="evaluaType">í‰ê°€ ìœ í˜•</label>
		        <input type="text" id="evaluaType" name="evaluaType" required>
		    </div>

		    <div class="form-group">
		        <label for="evaluaCriteria">í‰ê°€ í•­ëª©</label>
		        <input type="text" id="evaluaCriteria" name="evaluaCriteria" required>
		    </div>

		    <div class="form-group">
		        <label for="evaluaWeight">ê°€ì¤‘ì¹˜ (%)</label>
		        <input type="number" id="evaluaWeight" name="evaluaWeight" min="0" max="100" required>
		    </div>

		    <div class="form-group">
		        <label for="evaluaComment">ì„¸ë¶€</label>
		        <textarea id="evaluaComment" name="evaluaComment" rows="3"></textarea>
		    </div>

		    <div class="button-group">
		        <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
		        <button type="reset" class="btn btn-danger">ì´ˆê¸°í™”</button>
		    </div>
		</form>
    </div>

    <!-- ê¸°ì¡´ í‰ê°€ ë¦¬ìŠ¤íŠ¸ -->
    <div class="list-section">
        <h5>
		    <button onclick="navigateHalf(-1)"><<</button>
		    ì ìš©ì¤‘ì¸ KPI ëª©ë¡ (${evaluationYear}ë…„ ${halfYear} 
		        <c:choose>
		            <c:when test="${halfYear eq '1'}">ìƒë°˜ê¸°</c:when>
		            <c:when test="${halfYear eq '2'}">í•˜ë°˜ê¸°</c:when>
		            <c:otherwise>ë¯¸ì§€ì •</c:otherwise>
		        </c:choose>
		    )
		    <button onclick="navigateHalf(1)">>></button>
		</h5>
        <table>
            <thead>
                <tr>
                    <th>í‰ê°€ëŒ€ìƒ</th>
                    <th>ì—°ë„</th>
        			<th>ë°˜ê¸°</th>
                    <th>í‰ê°€ëª…</th>
                    <th>ìœ í˜•</th>
                    <th>í•­ëª©</th>
                    <th>ê°€ì¤‘ì¹˜</th>
                    <th>ì„¤ëª…</th>
                    <th>ì‚­ì œ</th>
                </tr>
            </thead>
            <tbody id="evaluationTableBody">
                <c:forEach var="x" items="${evaluTypeList}" varStatus="status">
                    <tr>
            			<td style="display: none"><input type="hidden" name="evaluationList[${status.index}].evaluaTypeId" value="${x.evaluaTypeId}" /></td>
                        <td>${x.rank.rankName }</td>
                        <td>${x.evaluationYear }</td>
            		    <td>
	            		    <c:choose>
	                    	    <c:when test="${x.halfYear eq '1'}">ìƒë°˜ê¸°</c:when>
			                    <c:when test="${x.halfYear eq '2'}">í•˜ë°˜ê¸°</c:when>
			                    <c:otherwise>-</c:otherwise>
	                        </c:choose>
                        </td>
                        <td>${x.evaluaName}</td>
                        <td>${x.evaluaType}</td>
                        <td>${x.evaluaCriteria}</td>
                        <td>${x.evaluaWeight}%</td>
                        <td>${x.evaluaComment}</td>
                        <c:set var="isEditable" value="${x.evaluationYear == evaluationYear and x.halfYear == halfYear}" />
                        <td>
                        	<c:if test="${isEditable}">
                        		<button class="btn btn-danger" onclick="deleteRow(this)">ì‚­ì œ</button>
							</c:if>		                        
                        </td>
                    </tr>
                </c:forEach>
            </tbody>
        </table>
        
        <!-- âœ… ì—¬ê¸° ì•„ë˜ì— ì¶”ê°€ -->
		<c:if test="${empty evaluTypeList}">
		    <p style="text-align:center; color:gray; margin-top:10px;">í•´ë‹¹ ì—°ë„/ë°˜ê¸°ì— ë“±ë¡ëœ KPI í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
		</c:if>
        
    </div>
</div>

</body>
