<%@ page contentType="text/html;charset=UTF-8" language="java"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>

<head>
<title>ì¸ì‚¬í‰ê°€ í˜„í™©íŒ</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.dashboard-card {
	border-radius: 1rem;
	padding: 1.5rem;
	color: white;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.card-blue {
	background-color: #007bff;
}

.card-green {
	background-color: #28a745;
}

.card-red {
	background-color: #dc3545;
}

.card-orange {
	background-color: #fd7e14;
}

hr.border-dark {
	border: 1px solid #444;
	margin: 6px 0;
}

.table-group-header td {
	background-color: #f0f2f5;
	border-top: 2px solid #888;
	font-weight: bold;
}

.back-btn {
	margin-bottom: 20px;
}
</style>
</head>

<body class="p-4">
	<div class="back-btn">
		<a href="/" class="btn btn-secondary">ğŸ”™ ë©”ì¸ìœ¼ë¡œ</a>
	</div>

	<h2 class="mb-4">
		ğŸ“Š ì¸ì‚¬í‰ê°€ í˜„í™©íŒ
		<c:choose>
			<c:when test="${empty evaluationYear}"></c:when>
			<c:otherwise> - ${evaluationYear}ë…„
        <c:choose>
					<c:when test="${halfYear == '1'}">ìƒë°˜ê¸°</c:when>
					<c:when test="${halfYear == '2'}">í•˜ë°˜ê¸°</c:when>
				</c:choose>
			</c:otherwise>
		</c:choose>
	</h2>

	<form class="row g-3 mb-4" method="get"
		action="/evaluation/evaluationDashboard">
		<div class="col-md-2">
			<label class="form-label">í‰ê°€ ì—°ë„</label> <select name="evaluationYear"
				class="form-select">
				<c:forEach var="year" begin="2020" end="2025">
					<option value="${year}"
						<c:if test="${evaluationYear == year}">selected</c:if>>${year}</option>
				</c:forEach>
			</select>
		</div>
		<div class="col-md-2">
			<label class="form-label">ë°˜ê¸°</label> <select name="halfYear"
				class="form-select">
				<option value="1" <c:if test="${halfYear == '1'}">selected</c:if>>ìƒë°˜ê¸°</option>
				<option value="2" <c:if test="${halfYear == '2'}">selected</c:if>>í•˜ë°˜ê¸°</option>
			</select>
		</div>
		<div class="col-md-2 d-flex align-items-end">
			<button class="btn btn-primary w-100">ì¡°íšŒ</button>
		</div>
	</form>

	<!-- ìš”ì•½ ì¹´ë“œ -->
	<div class="row mb-4">
		<div class="col-md-3">
			<div class="dashboard-card card-blue text-center">
				<h5>ì „ì²´ í‰ê°€ ëŒ€ìƒì</h5>
				<h2>${summary.totalTarget}ëª…</h2>
			</div>
		</div>
		<div class="col-md-3">
			<div class="dashboard-card card-green text-center">
				<h5>í‰ê°€ ì™„ë£Œ</h5>
				<h2>${summary.completed}ëª…</h2>
			</div>
		</div>
		<div class="col-md-3">
			<div class="dashboard-card card-red text-center">
				<h5>í‰ê°€ ë¯¸ì™„ë£Œ</h5>
				<h2>${summary.notCompleted}ëª…</h2>
			</div>
		</div>
		<div class="col-md-3">
			<div class="dashboard-card card-orange text-center">
				<h5>í‰ê°€ ì§„í–‰ë¥ </h5>
				<h2>${summary.completionRate}%</h2>
			</div>
		</div>
	</div>

	<!-- ì°¨íŠ¸ -->
	<div class="card p-4 mb-4">
		<h5>í˜„í™©</h5>
		<canvas id="departmentChart" height="300"></canvas>
	</div>

	<!-- ë³¸ë¶€ë³„ í…Œì´ë¸” -->
	<div class="card p-4 mb-4">
		<h5 class="mb-3">ë³¸ë¶€ë³„</h5>
		<table class="table table-bordered text-center">
			<thead class="table-light">
				<tr class="table-primary fw-bold">
					<th>ë¶€ì„œ</th>
					<th>ëŒ€ìƒì ìˆ˜</th>
					<th>ì™„ë£Œ</th>
					<th>ë¯¸ì™„ë£Œ</th>
					<th>ì™„ë£Œìœ¨</th>
				</tr>
			</thead>
			<tbody>
				<c:forEach var="row" items="${departmentSummary}">
					<tr>
						<td>${row.departmentName}</td>
						<td>${row.targetCount}</td>
						<td>${row.completedCount}</td>
						<td>${row.notCompletedCount}</td>
						<td>${row.completionRate}%</td>
					</tr>
				</c:forEach>
			</tbody>
		</table>
	</div>

	<!-- íŒ€ë³„ í…Œì´ë¸” -->
	<div class="card p-4">
		<h5 class="mb-3">íŒ€ë³„</h5>
		<table class="table table-bordered text-center">
			<thead class="table-light">
				<tr class="table-primary fw-bold">
					<th>ë³¸ë¶€</th>
					<th>íŒ€</th>
					<th>ëŒ€ìƒì ìˆ˜</th>
					<th>ì™„ë£Œ</th>
					<th>ë¯¸ì™„ë£Œ</th>
					<th>ì™„ë£Œìœ¨</th>
					<th>ë¯¸ì œì¶œì</th>
				</tr>
			</thead>
			<tbody>
				<c:set var="currentHQ" value="" />
				<c:forEach var="row" items="${dashboardList}">
					<c:if test="${currentHQ != row.departmentName}">
						<tr class="table-group-header">
							<td colspan="7" class="fw-bold">${row.departmentName}</td>
						</tr>
						<c:set var="currentHQ" value="${row.departmentName}" />
					</c:if>
					<tr>
						<td></td>
						<td>${row.teamName}</td>
						<td>${row.targetCount}</td>
						<td>${row.completedCount}</td>
						<td>${row.notCompletedCount}</td>
						<td>${row.completionRate}%</td>
						<td>
							<button class="btn btn-sm btn-outline-danger"
								onclick="location.href='/evaluation/unsubmittedModal?year=${evaluationYear}&half=${halfYear}&teamId=${row.teamId}'">
								ë¯¸ì œì¶œì ë³´ê¸°</button>
						</td>
					</tr>
				</c:forEach>
			</tbody>
		</table>
	</div>

	<!-- ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ -->
	<script>
    document.addEventListener("DOMContentLoaded", function () {
      try {
        const chartData = JSON.parse('<c:out value="${chartDataJson}" escapeXml="false" />');
        const labels = chartData.map(item => item.DEPARTMENT_NAME);
        const completeData = chartData.map(item => item.COMPLETEDCOUNT);
        const incompleteData = chartData.map(item => item.NOTCOMPLETEDCOUNT);

        const ctx = document.getElementById('departmentChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              { label: 'ì™„ë£Œ', data: completeData, backgroundColor: '#28a745' },
              { label: 'ë¯¸ì™„ë£Œ', data: incompleteData, backgroundColor: '#dc3545' }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'ì§„í–‰ë¥ ' },
              legend: { position: 'top' }
            },
            scales: {
              x: { stacked: true },
              y: { stacked: true, beginAtZero: true }
            }
          }
        });
      } catch (e) {
        console.error("ì°¨íŠ¸ ë Œë”ë§ ì‹¤íŒ¨:", e);
      }
    });
  </script>
</body>
