/** 
 * <pre>
 * << ê°œì •ì´ë ¥(Modification Information) >>
 *   ìˆ˜ì •ì¼         ìˆ˜ì •ì         ìˆ˜ì •ë‚´ìš©
 *  -----------      -------------    ---------------------------
 * 2025. 3. 25.    youngjun         ìµœì´ˆ ìƒì„±
 * </pre>
 */
document.addEventListener("DOMContentLoaded", () => {
    document.addEventListener("click", (e) => {
        if (e.target.classList.contains("open-detail-modal")) {
            const empId = e.target.dataset.empid;
            const payYear = e.target.dataset.payyear;
            const payMonth = e.target.dataset.paymonth;
            const payStatus = e.target.dataset.paystatus;

            if (payStatus === 'í™•ì •') {
                const url = `/salary/detail/${empId}/${payYear}/${payMonth}`;

				const modalHtml = `
				<div class="modal fade" id="iframeModal" tabindex="-1">
				  <div class="modal-dialog modal-xl modal-dialog-centered">
				    <div class="modal-content">
				      <div class="modal-header bg-white text-white">
				        <h5 class="modal-title text-center w-100"></h5>
				        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				      </div>
				      <div class="modal-body">
					  
					  
					  <iframe id="previewIframe"
					          src="${url}"
					          style="width:100%; height:900px; border:none;"
					          data-empid="${empId}"
					          data-payyear="${payYear}"
					          data-paymonth="${payMonth}"></iframe>
				        
				        <!-- ê¸‰ì—¬ëª…ì„¸ì„œ ë‹¨ê±´ë°œì†¡ -->
				        <div class="d-flex flex-column align-items-end mt-3">
				          <button type="button" class="btn btn-danger btn-sm mb-2" id="sendPaystubBtn">ğŸ“§ ê¸‰ì—¬ëª…ì„¸ì„œ ë°œì†¡</button>
				          <p class="text-danger fw-bold mb-0">â€» í™•ì •ëœ ê¸‰ì—¬ë¡œ ìˆ˜ì •ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.</p>
				        </div>

				        <div id="imagePreviewArea" style="display:none; margin-top:20px;">
				          <img id="imagePreview" style="width:100%; border:1px solid #ccc;" />
				        </div>
				      </div>
				    </div>
				  </div>
				</div>`;


                const wrapper = document.createElement("div");
                wrapper.innerHTML = modalHtml;
                document.body.appendChild(wrapper);

                const modal = new bootstrap.Modal(wrapper.querySelector("#iframeModal"));
                modal.show();

                wrapper.querySelector("#iframeModal").addEventListener("hidden.bs.modal", () => {
                    wrapper.remove();
                });

            } else {
                // í™•ì •ëŒ€ê¸°ì¼ ë•Œ: ìˆ˜ì • ê°€ëŠ¥í•œ ëª¨ë‹¬ ì—´ê¸°
                $.ajax({
                    url: `/salary/detail/${empId}/${payYear}/${payMonth}`,
                    type: "GET",
                    success: function (html) {
                        document.querySelector("#exampleModal .modal-body").innerHTML = html;
                        const modal = new bootstrap.Modal(document.getElementById("exampleModal"));
                        modal.show();
                    },
                    error: function () {
                        alert("ê¸‰ì—¬ëª…ì„¸ì„œ ë¡œë”© ì‹¤íŒ¨");
                    }
                });
            }
        }
    });
});

function captureIframe() {
    const iframe = document.getElementById("previewIframe");
    const iframeDoc = iframe.contentWindow.document;

    html2canvas(iframeDoc.body).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        document.getElementById("imagePreview").src = imgData;
        document.getElementById("imagePreviewArea").style.display = 'block';
    });
}
