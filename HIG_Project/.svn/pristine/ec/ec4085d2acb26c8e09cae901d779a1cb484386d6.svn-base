<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form" %>
<%@ taglib uri="http://www.springframework.org/security/tags"
	prefix="security"%>
<style>
/* í€µë©”ë‰´ë°” ìŠ¤íƒ€ì¼ - ê¸°ì¡´ ìœ ì§€ */
.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    margin-bottom: 20px;
    background-color: transparent; 
    box-shadow: none;
    border: none;
}
</style>    
 <!-- í€µë©”ë‰´ë°” ì˜ì—­ - ê¸°ì¡´ ì½”ë“œ ìœ ì§€ -->
<div class="top-bar">
    <!-- ì¢Œì¸¡: ë²„íŠ¼ ê·¸ë£¹ -->
    <div>	 
        <button type="button" class="btn btn-outline-secondary" onclick="history.back();">
            <i class="fas fa-arrow-left"></i> 
        </button>
    </div>
    
    <!-- ìš°ì¸¡: Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item fw-bold text-primary">ğŸ“Œ Quick Menu</li>
            <li class="breadcrumb-item"><a href="/approval/templateList">ë¬¸ì„œì‘ì„±</a></li>
            <li class="breadcrumb-item"><a href="/approval/mydrafts">ì œì¶œë¬¸ì„œ</a></li>
            <li class="breadcrumb-item"><a href="/approval/approverDrafts">ê²°ì¬í˜„í™©</a></li>
            <security:authorize access="hasAnyRole('HR_MANAGER', 'HR_ADMIN')">
                <li class="breadcrumb-item active" aria-current="page">ê²°ì¬ì–‘ì‹</li>
            </security:authorize>
        </ol>
    </nav>
</div>
    
<section class="section">
    <div class="card">
        <!-- í—¤ë” -->
        <div class="card-header">    
    		<h2><i class="fas fa-file-alt me-2"></i>ê²°ì¬ ì–‘ì‹ ìˆ˜ì •</h2>
    	</div>
    	
    <form action="${pageContext.request.contextPath}/approval/approvalUpdate" 
          method="post" enctype="multipart/form-data">
    	<div class="card-body">
        <!-- ê¸°ì¡´ ë°ì´í„°ë¥¼ ì‚­ì œ í›„ ìƒˆë¡œìš´ ë°ì´í„° ì¶”ê°€ -->
        <input type="hidden" name="templateId" value="${templateVO.templateId}">
        
        <div class="row mb-3">
            <label for="templateTite" class="col-sm-2 col-form-label">ì–‘ì‹ ì œëª©</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="templateTite"
                    id="templateTite" value="${templateVO.templateTite}">
                <form:errors path="templateTite" class="text-danger" element="span" />
            </div>
        </div>

        <!-- ì–‘ì‹ ë‚´ìš© textarea -->
        <div class="row mb-3">
            <label for="templateContent" class="col-sm-2 col-form-label">ì–‘ì‹ ë‚´ìš©</label>
            <div class="col-sm-10">
                <textarea class="form-control" name="templateContent"
                          id="contentEditor" rows="10">${templateVO.templateContent}</textarea>
                <form:errors path="templateContent" class="text-danger" element="span"/>
            </div>
        </div>

        <!-- ì–‘ì‹ ì¹´í…Œê³ ë¦¬ -->
        <div class="row mb-3">
            <label for="templateCategory" class="col-sm-2 col-form-label">ì–‘ì‹ ì¹´í…Œê³ ë¦¬</label>
            <div class="col-sm-10">
                <select name="templateCategory" class="form-control">
                    <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                    <c:forEach var="category" items="${categoryList}">
                        <option value="${category}" ${category eq templateVO.templateCategory ? 'selected' : ''}>
                            ${category}
                        </option>
                    </c:forEach>
                </select>
                <form:errors path="templateCategory" class="text-danger" element="span" />
            </div>
        </div>

        <div class="row mb-3">
            <label for="templateDeleted" class="col-sm-2 col-form-label">ì–‘ì‹ ì‚­ì œ ì—¬ë¶€ (Y,N)</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" name="temlpateDeleted"
                    id="templateDeleted" value="${templateVO.temlpateDeleted}">
                <form:errors path="templateDeleted" class="text-danger" element="span" />      
            </div>
        </div>

        <!-- ê¸°ì¡´ íŒŒì¼ í‘œì‹œ ë° ë‹¤ìš´ë¡œë“œ, ë¬¼ë¦¬ ì‚­ì œ ë²„íŠ¼ -->
        <c:if test="${not empty templateVO.fileDetails}">
            <div class="row mb-3">
                <label class="col-sm-2 col-form-label">ì²¨ë¶€ íŒŒì¼</label>
                <div class="col-sm-10">
                    <c:forEach var="file" items="${templateVO.fileDetails}">
                        <div style="margin-bottom: 10px;">
                            <a href="${pageContext.request.contextPath}/file/download/${file.detailId}">
                                ${file.fileName}
                            </a>
                            <!-- íŒŒì¼ ë¬¼ë¦¬ ì‚­ì œ ë²„íŠ¼ (X ì•„ì´ì½˜) -->
                            <button type="button" class="btn btn-danger btn-sm me-3"
                                    onclick="deleteFilePhysically('${file.detailId}', '${file.fileSavename}')"
                                    title="íŒŒì¼ ì‚­ì œ">
                                X
                            </button>
                            <input type="hidden" name="existingFileIds" value="${file.detailId}">
                        </div>
                    </c:forEach>
                </div>
            </div>
        </c:if>

        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
        <div class="row mb-3">
            <label for="files" class="col-sm-2 col-form-label">íŒŒì¼ ì—…ë¡œë“œ</label>
            <div class="col-sm-10">
                <input type="file" class="form-control" name="files" id="files" multiple ${empty templateVO.fileDetails ? "required" : ""}>
                <small class="text-muted">
                    <c:choose>
                        <c:when test="${empty templateVO.fileDetails}">
                            íŒŒì¼ì„ ë°˜ë“œì‹œ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.
                        </c:when>
                        <c:otherwise>
                            íŒŒì¼ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ íŒŒì¼ì´ ìœ ì§€ë©ë‹ˆë‹¤.
                        </c:otherwise>
                    </c:choose>
                </small>
            </div>
        </div>
        <div class="d-flex justify-content-end mt-3">
            <a class="btn btn-secondary me-2" href="${pageContext.request.contextPath}/approval/list">
                <i class="fas fa-list"></i> ì–‘ì‹ ëª©ë¡
            </a>
            <button type="submit" class="btn btn-primary"><i class="fas fa-edit"></i> ìˆ˜ì •</button>
        </div>
    </form>
 </div>
</section>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function(){
    CKEDITOR.replace('contentEditor', {
        versionCheck: false
    });
    
    /**
     * ë¬¼ë¦¬ íŒŒì¼ ì‚­ì œ ìš”ì²­ í•¨ìˆ˜
     * @param {string} detailId - FILE_DETAIL í…Œì´ë¸”ì˜ DETAIL_ID
     * @param {string} fileSavename - ì‹¤ì œ ì €ì¥ëœ íŒŒì¼ëª… (UUID í¬í•¨)
     */
    function deleteFilePhysically(detailId, fileSavename) {
        if (!confirm('" íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? \n(ë³µêµ¬ ë¶ˆê°€)')) {
            return;
        }
        
        // AJAXë¥¼ ì´ìš©í•˜ì—¬ ì„œë²„ì— ë¬¼ë¦¬ ì‚­ì œ ìš”ì²­ (DELETE)
        fetch(window.contextPath + "/file/physical/" + detailId, {
            method: "DELETE"
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error("íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨ (server error)");
            }
            return response.text(); // ì„±ê³µ ì‹œ ì„œë²„ ë©”ì‹œì§€ ë°˜í™˜
        })
        .then(function(msg) {
            alert(msg);
            // ì‚­ì œ í›„ í˜ì´ì§€ ë¦¬ë¡œë“œ ë˜ëŠ” íŒŒì¼ ëª©ë¡ì—ì„œ í•´ë‹¹ íŒŒì¼ ì œê±°
            location.reload();
        })
        .catch(function(err) {
            console.error("íŒŒì¼ ë¬¼ë¦¬ ì‚­ì œ ì‹¤íŒ¨:", err);
            alert("íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err);
        });
    }
    
    // ì „ì—­ì— ë…¸ì¶œ (ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡)
    window.deleteFilePhysically = deleteFilePhysically;
});
</script>
