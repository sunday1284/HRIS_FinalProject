<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<!-- ìŠ¤íƒ€ì¼ -->
<style>
  body {
    padding: 40px;
    background-color: #f8f9fa;
    font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
  }
  h3 {
    margin-bottom: 25px;
    font-weight: 600;
  }
  .table th, .table td {
    text-align: center;
    vertical-align: middle !important;
    padding: 10px;
    font-size: 15px;
    line-height: 1.6;
    white-space: nowrap;
    
  }
  .table thead th {
    text-align: center !important;
    background-color: #eff6ff;
    font-weight: 600;
    color: #0d47a1;
    border-top: 2px solid #c6dafc;
    white-space: nowrap;
  }
  .table-hover tbody tr:hover {
    background-color: #e3f2fd;
  }
  .btn-link-group {
    margin-bottom: 20px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
</style>

<script
	src="${pageContext.request.contextPath}/resources/js/employee/empDetail.js"></script>

<div class="page-container container-fluid">
	<div class="d-flex justify-content-between align-items-center mb-2">

		<!-- ì¢Œì¸¡: ë²„íŠ¼ ê·¸ë£¹ -->
		<div>
			<button type="button" class="btn btn-outline-secondary"
				onclick="history.back();">
				<i class="fas fa-arrow-left"></i>
			</button>
		</div>

		<!-- ìš°ì¸¡: Breadcrumb -->
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb mb-0">
				<li class="breadcrumb-item fw-bold text-primary"><a
					href="${pageContext.request.contextPath }/account/login/home">ğŸ“ŒMain</a></li>
				<li class="breadcrumb-item active" aria-current="page">ì§ì›ê´€ë¦¬</li>
				<li class="breadcrumb-item"><a href="${pageContext.request.contextPath }/employee/appointList">ì¸ì‚¬ë°œë ¹</a></li>
				<li class="breadcrumb-item"><a href="${pageContext.request.contextPath }/employee/resignList">í‡´ì‚¬ìê´€ë¦¬</a></li>
			</ol>
		</nav>

	</div>
</div>
<br />

<h3>ì§ì›ê´€ë¦¬</h3>
<div class="row">
	<!-- ì™¼ìª½ ì¹´ë“œ -->
	<div class="col-md-6">
		<div class="card h-100" style="min-height: 500px;">
			<div class="card-body">
				<div class="chart-container text-center" style="height: 90%;">
					<h4>ğŸ“¥ ê·¼ì† ì—°ìˆ˜</h4>
					<canvas id="tenure"
						style="display: block; margin: 0 auto; width: 100%; max-width: 650px; height: 400px;"></canvas>
				</div>
			</div>
		</div>
	</div>

	<!-- ì˜¤ë¥¸ìª½ ì¹´ë“œ -->
	<div class="col-md-6">
		<div class="card h-100" style="min-height: 550px;">
			<div class="card-body">
				<div class="chart-container text-center" style="height: 100%;">
					<h4>ğŸ’¼ ì§ê¸‰ë³„ ë¹„ìœ¨</h4>
					<canvas id="rankPercent"
						style="display: block; margin: 0 auto; width: 100%; max-width: 500px; height: 400px;"></canvas>
				</div>
			</div>
		</div>
	</div>
</div>
<br />

<!-- ğŸ”— ë§í¬ ë²„íŠ¼ -->
<div class="btn-link-group">
  <a href="${pageContext.request.contextPath}/employee/empFormUI" class="btn btn-primary">
    <i class="bi-person-plus"></i> ì‹ ê·œì§ì›ë“±ë¡
  </a>
  <a href="${pageContext.request.contextPath}/employee/appointList" class="btn btn-primary">
    <i class="bi-person-check"></i> ì¸ì‚¬ë°œë ¹ ì´ë™
  </a>
  <a href="${pageContext.request.contextPath}/employee/resignList" class="btn btn-outline-danger">
    <i class="bi-person-dash"></i> í‡´ì‚¬ì ê´€ë¦¬ ì´ë™
  </a>
</div>

<div class="card">
	<div class="card-body">
	<h4>ì§ì›ì •ë³´ ë¦¬ìŠ¤íŠ¸</h4>
		<table class="table table-striped table-bordered table-hover" id="empTable">
			<thead>
				<tr>
					<th>í”„ë¡œí•„</th>
					<th>ì´ë¦„</th>
					<th>ì‚¬ë²ˆ</th>
					<th>íœ´ëŒ€í°</th>
					<th>ì´ë©”ì¼</th>
					<th>ë¶€ì„œëª…</th>
					<th style="width: 50px;">íŒ€ëª…</th>
					<th>ì§ê¸‰</th>
					<th>ì§ì±…</th>
					<th>ì§ë¬´</th>
					<th>ì…ì‚¬ì¼ì</th>
					<th>ì¸ì‚¬ê¸°ë¡ì¹´ë“œ</th>
				</tr>
			</thead>
			<tbody>
				<c:forEach items="${empList}" var="x">
					<c:set var="fullPath" value="${x.empPath}" />
					<c:set var="startIndex"
						value="${fn:indexOf(fullPath, 'fileImages')}" />
					<c:set var="cutStart" value="${startIndex + 10}" />
					<c:set var="cutEnd" value="${fn:length(fullPath)}" />
					<c:set var="fileName"
						value="${fn:substring(fullPath, cutStart, cutEnd)}" />
					<c:set var="webPath" value="/resources/fileImages/${fileName}" />
					<tr>
						<td><img src="${pageContext.request.contextPath}${webPath}"
							style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;"
							onerror="this.onerror=null; this.src='${pageContext.request.contextPath}/resources/template/dist/assets/static/images/faces/1.jpg';"
							alt="í”„ë¡œí•„" /></td>
						<td>${x.name }</td>
						<td>${x.empId }</td>
						<td>${x.phoneNumber }</td>
						<td>${x.email }</td>
						<td>${x.department.departmentName }</td>
						<td>${x.team.teamName }</td>
						<td>${x.rank.rankName }</td>
						<td>${x.job.jobName }</td>
						<td>${x.position.positionName }</td>
						<td><fmt:parseDate value="${x.hireDate}"
								pattern="yyyy-MM-dd HH:mm:ss" var="parsedHireDate" /> <fmt:formatDate
								value="${parsedHireDate}" pattern="yyyy-MM-dd" /></td>
						<td>
							<button type="button" class="btn btn-primary"
								data-bs-toggle="modal" data-bs-target="#exampleModal1"
								data-emp-id="${x.empId}">ì—´ëŒ</button>
						</td>
					</tr>
				</c:forEach>
			</tbody>
		</table>
		<br> <br>
		
		<!-- Modal -->
		<div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-scrollable">
				<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="exampleModalLabel">ì¸ì‚¬ê¸°ë¡ì¹´ë“œ</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body" style="max-width: 1000px;"></div>
					<div class="modal-footer">
					  <div class="btn-area">
					    <a class="btn btn-primary" href="${empUpdate}">
					      <i class="bi bi-pencil-square me-1"></i>ì •ë³´ ìˆ˜ì •
					    </a>
					  </div>
						<button type="button" class="btn btn-secondary" id="closeButton"
							data-bs-dismiss="modal">ë‹«ê¸°</button>
					</div>
				</div>
			</div>
		</div>
		
	</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
	const today = new Date();
	const year = today.getFullYear();
	
	$.ajax({
		url: "/employee/rankPercent",
		type: "GET",
		success: function(data) {
			rankPercent(data);		
		},
		error: function() {
			alert("ìš”ì•½ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨");
		}
	});
	
	$.ajax({
		url: "/employee/tunurePercent",
		type: "GET",
		success: function(data) {
 			tenure(data);		
		},
		error: function() {
			alert("ìš”ì•½ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨");
		}
	});
});	

	Chart.register(ChartDataLabels);
	// ì§ê¸‰ë³„ ì¸ì›ìˆ˜ ë¹„ìœ¨
function rankPercent(data) {
	const total = data.reduce((sum, item) => sum + item.COUNT, 0);

	const labels = data.map(item => item.RANK_NAME);
	const percentages = data.map(item => ((item.COUNT / total) * 100).toFixed(1));
	const rawCounts = data.map(item => item.COUNT);

	const backgroundColors = [
		'#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
		'#9966FF', '#FF9F40', '#C9CBCF', '#5AD3D1'
	];

	new Chart(document.getElementById('rankPercent'), {
		type: 'doughnut',
		data: {
			labels: labels,
			datasets: [{
				label: 'ì§ê¸‰ ë¹„ìœ¨',
				data: rawCounts,
				backgroundColor: backgroundColors,
				borderWidth: 1
			}]
		},
		options: {
			responsive: true,
			plugins: {
				legend: {
					position: 'bottom',
					labels: {
						filter: function(legendItem, chartData) {
							const index = legendItem.index;
							const value = parseFloat(chartData.datasets[0].data[index]);
							// âœ… í¼ì„¼íŠ¸ 5% ë¯¸ë§Œì¸ í•­ëª©ë§Œ ë ˆì „ë“œì— í‘œì‹œ
							return value < 5;
						}
					}
				},
				tooltip: {
					callbacks: {
						label: function(context) {
							const index = context.dataIndex;
							const count = rawCounts[index];
							const percentage = percentages[index];
							return `\${context.label}: \${count}ëª…`;
						}
					}
				},
				datalabels: {
					anchor: 'center',
					align: 'center',
					display: function(context) {
						const value = parseFloat(context.dataset.data[context.dataIndex]);
						return value >= 5; // âœ… 5% ì´ìƒë§Œ ë¼ë²¨ë¡œ
					},
					formatter: function(value, context) {
						const percent = ((value / total) * 100).toFixed(1);
						return `\${context.chart.data.labels[context.dataIndex]}\n\${percent}%`;
					},
					color: '#000',
					font: {
						weight: 'bold',
						size: 17
					}
				}
			}
		},
		plugins: [ChartDataLabels]
	});
}

//ê·¼ì† ì—°ìˆ˜ë³„ ì¸ì›ìˆ˜ ë¹„ìœ¨ - ìˆ˜í‰ ë§‰ëŒ€ ê·¸ë˜í”„
function tenure(deptData) {
	const labels = deptData.map(item => {
		if (item.TENUREYEAR < 0) return 'ì…ì‚¬ì˜ˆì •';
		else return `\${item.TENUREYEAR}ë…„`;
	});

	const data = deptData.map(item => item.COUNT);
	const total = data.reduce((sum, val) => sum + val, 0);

	const backgroundColors = [
		'#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
		'#9966FF', '#FF9F40', '#C9CBCF', '#5AD3D1',
		'#B39DDB', '#FFCDD2', '#AED581', '#81D4FA'
	];

	new Chart(document.getElementById('tenure'), {
		type: 'bar',
		data: {
			labels: labels,
			datasets: [{
				label: 'ê·¼ì† ì—°ìˆ˜ë³„ ì¸ì› ìˆ˜',
				data: data,
				backgroundColor: backgroundColors,
			}]
		},
		options: {
			indexAxis: 'y', // ğŸ‘ˆ ìˆ˜í‰ ë§‰ëŒ€ ê·¸ë˜í”„ë¡œ ë§Œë“œëŠ” í•µì‹¬ ì˜µì…˜
			responsive: true,
			plugins: {
				legend: {
					display: false // ë§‰ëŒ€ê·¸ë˜í”„ëŠ” ë²”ë¡€ í•„ìš” ì—†ìœ¼ë©´ ë„ëŠ” ê²ƒë„ ê¹”ë”í•¨
				},
				tooltip: {
					callbacks: {
						label: function(context) {
							const label = context.label || '';
							const value = context.raw;
							const percent = ((value / total) * 100).toFixed(1);
							return `\${label}: \${value}ëª…`;
						}
					}
				},
				datalabels: {
					anchor: 'center',
					align: 'center',
					display: function(context) {
						const value = parseFloat(context.dataset.data[context.dataIndex]);
						return value >= 5; // 5ëª… ì´ìƒì¼ ë•Œë§Œ ë¼ë²¨ í‘œì‹œ
					},
					formatter: function(value, context) {
						const percent = ((value / total) * 100).toFixed(1);
						const label = context.chart.data.labels[context.dataIndex];
						return `\${label}: \${percent}%`;
					},
					color: '#000',
					font: {
						weight: 'bold',
						size: 17
					}
				}
			},
			scales: {
				x: {
					beginAtZero: true,
					ticks: {
						stepSize: 5
					}
				}
			}
		},
		plugins: [ChartDataLabels]
	});
}
$(document).ready(function() {
    $('#empTable').DataTable({
      "language": {
        "search": "ê²€ìƒ‰:",
        "lengthMenu": "_MENU_ í•­ëª©ì”© ë³´ê¸°",
        "info": "ì´ _TOTAL_ëª… ì¤‘ _START_~_END_ í‘œì‹œ",
        "paginate": {
          "next": "ë‹¤ìŒ",
          "previous": "ì´ì „"
        },
        "zeroRecords": "ì¼ì¹˜í•˜ëŠ” ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.",
        "infoEmpty": "ì§ì› ì—†ìŒ",
        "infoFiltered": "(ì „ì²´ _MAX_ëª… ì¤‘ í•„í„°ë§ë¨)"
      },
      "pageLength": 10,
      "lengthMenu": [10, 20, 30, 50]
    });
  });

</script>

